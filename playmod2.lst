     1                                  ; ****************************************************************************
     2                                  ; playmod2.asm (for MSDOS)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYMOD2.COM ! ICH AC97 MOD PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 18/02/2017
     7                                  ;
     8                                  ; [ Last Modification: 14/05/2024 ]
     9                                  ;
    10                                  ; Derived from source code of 'PLAYWAV.COM' ('PLAYWAV.ASM') by Erdogan Tan
    11                                  ;							      (17/02/2017)
    12                                  ; Modified from 'PLAYMOD.COM' ('playmod.asm') source code 
    13                                  ;		 VIA VT8237 MOD PLAYER & VGA DEMO program by Erdogan TAN
    14                                  ;							     (15/02/2017)	
    15                                  ;
    16                                  ; Derived from source code of 'PLAY.EXE' (TINYPLAY) by Carlos Hasan (1993)
    17                                  ;          PLAY.EXE: PLAY.ASM, MODLOAD.ASM, MODPLAY.ASM, SB.ASM
    18                                  ;
    19                                  ; Assembler: NASM 2.11
    20                                  ; ----------------------------------------------------------------------------
    21                                  ;	   nasm  playmod2.asm -l playmod2.lst -o PLAYMOD2.COM	
    22                                  ; ****************************************************************************
    23                                  
    24                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
    25                                  ;		July 14th, 1993.
    26                                  
    27                                  ;=============================================================================
    28                                  ;               PLAYWAV.ASM / PLAYER.ASM / TINYPLAY.ASM
    29                                  ;=============================================================================
    30                                  ; Audio controller, codec & PCI functions are derived from '.wav file player 
    31                                  ; for DOS' source code by Jeff Leyda (PLAYER.EXE), Sep 02, 2002.
    32                                  
    33                                  ; TUNELOOP version ; 12/05/2024
    34                                  
    35                                  [BITS 16]
    36                                  [org 100h]
    37                                  
    38                                  Start:
    39 00000000 E8CF00                  	call    DetectICH		; Detect AC97 Audio Device
    40                                  GetFileName:    			; Parse  the Command line...
    41 00000003 BE8000                  	mov	si, 80h
    42 00000006 8A1C                    	mov	bl, [si]
    43 00000008 30FF                    	xor	bh, bh
    44 0000000A 43                      	inc	bx
    45 0000000B C60000                  	mov	byte [si+bx], 0		; make AsciiZ filename.
    46 0000000E 46                      	inc	si
    47                                  ScanName:       
    48 0000000F AC                      	lodsb
    49 00000010 84C0                    	test	al, al
    50 00000012 0F84B200                	je	pmsg_2017
    51 00000016 3C20                    	cmp	al, 20h
    52 00000018 74F5                    	je	short ScanName		; scan start of name.
    53 0000001A 89F7                    	mov	di, si
    54 0000001C 4F                      	dec	di
    55                                  ScanPeriod:
    56 0000001D AC                      	lodsb
    57 0000001E 3C2E                    	cmp	al, '.'			; if period NOT found,
    58 00000020 7410                    	je	short PrintMesg		; then add a .MOD extension.
    59 00000022 84C0                    	test	al, al
    60 00000024 75F7                    	jnz	short ScanPeriod
    61 00000026 4E                      	dec	si
    62                                  SetExt:
    63                                  	;mov	byte [si+0], '.'
    64                                  	;mov	byte [si+1], 'M'
    65                                  	;mov	byte [si+2], 'O'
    66                                  	;mov	byte [si+3], 'D'
    67 00000027 66C7042E4D4F44          	mov	dword [si], '.MOD'
    68 0000002E C6440400                	mov	byte [si+4], 0
    69                                  
    70                                  PrintMesg:
    71 00000032 B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    72                                  	;lea	dx, [Credits]
    73 00000035 BA[BC0D]                	mov	dx, Credits
    74 00000038 CD21                    	int	21h
    75                                  
    76                                  	; 13/05/2024
    77 0000003A E8E00B                  	call	write_ac97_dev_info
    78 0000003D B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    79 00000040 BA[ED0D]                	mov	dx, CRLF
    80 00000043 CD21                    	int	21h
    81                                  LoadMod:  
    82                                  	; es:di = Filename address
    83 00000045 06                      	push	es
    84 00000046 57                      	push	di
    85 00000047 E8F804                  	call    LoadModule		; Load the MODule...
    86                                  
    87 0000004A 833E[A660]00            	cmp     word [ErrorInfo], 0	; any error loading?
    88 0000004F 740A                    	je      short init_codec
    89                                  
    90 00000051 B80009                  	mov     ax, 0900h		; yes, print error and Exit.
    91                                  	;lea    dx, [ErrorMesg]
    92 00000054 BA[F00D]                	mov	dx, ErrorMesg
    93 00000057 CD21                    	int     21h
    94 00000059 EB66                    	jmp     Exit
    95                                  
    96                                  init_codec:
    97 0000005B E8BF0B                  	call	write_ac97_dev_info
    98                                  
    99                                  	; 08/05/2024
   100                                  	; 17/02/2017
   101                                  	;mov	dx, [stats_cmd]
   102                                          ;or	dl, IO_ENA+BM_ENA		; enable IO and bus master
   103                                          ;call	pciRegWrite16 ; pciRegWrite8
   104                                  
   105                                  	; 18/02/2017
   106 0000005E C706[E464]2256          	mov	word [sample_rate], 22050	; Mixing at 22.050 kHz
   107                                  
   108                                  	; 08/05/2024
   109                                  	; (48 kHZ mixing is necessary 
   110                                  	;  if the AC97 hardware/codec has not got VRA feature)
   111                                  	; ((or frequency converting code would be needed))
   112                                  	;mov	word [sample_rate], 48000	; Mixing at 48 kHz
   113                                  
   114                                  ; setup the Codec (actually mixer registers)
   115 00000064 E8FD01                          call    codecConfig			; unmute codec, set rates.
   116 00000067 731A                    	jnc	short PlayNow
   117                                  
   118                                  _codec_err:
   119 00000069 0E                      	push	cs
   120 0000006A 1F                      	pop	ds
   121 0000006B BA[7400]                        mov	dx, CodecErrMsg
   122 0000006E B409                            mov     ah, 9
   123 00000070 CD21                            int     21h
   124 00000072 EB4D                            jmp     Exit
   125                                  
   126 00000074 436F64656320457272-     CodecErrMsg db "Codec Error!"
   126 0000007D 6F7221             
   127 00000080 0D0A24                  	db	CR,LF,"$"
   128                                  PlayNow:  
   129 00000083 B8[A40F]                	mov	ax, BdlBuffer
   130 00000086 A3[920F]                	mov	[BDL_BUFFER], ax
   131                                      
   132 00000089 B8[A410]                	mov	ax, DmaBuffer		; DmaBuffer (4096 bytes) buff addr
   133 0000008C A3[940F]                	mov	[DMA_BUFFER1], ax	; 2048 byte half buffer 1 
   134                                  
   135 0000008F 050028                  	add	ax, BUFFERSIZE		; code/current segment
   136 00000092 A3[960F]                	mov	[DMA_BUFFER2], ax	; 2048 byte half buffer 2
   137                                    
   138                                  	;mov    word [MixSpeed], 22050	; Mixing at 22.050 kHz
   139                                  
   140 00000095 E8780A                  	call    StartPlaying
   141                                  
   142 00000098 B81300                  	mov     ax, 0013h		; Set Mode 320x200x256
   143 0000009B CD10                    	int     10h
   144                                  
   145 0000009D B98000                  	mov     cx, 128			; Make a lookup table
   146 000000A0 31DB                    	xor     bx, bx			; for fastest pixel
   147 000000A2 BA002D                  	mov     dx, 320*(100-64)	; addressing.
   148                                  MakeOfs:        
   149 000000A5 8997[B0C1]              	mov     [RowOfs+bx], dx
   150 000000A9 8997[B2C1]              	mov     [RowOfs+bx+2], dx
   151 000000AD 81C24001                	add     dx, 320
   152 000000B1 83C304                  	add     bx, 4
   153 000000B4 E2EF                    	loop    MakeOfs
   154                                  
   155                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   156                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   157                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   158                                  ;       second, or the module will sound "looped".
   159                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   160                                  ;       the polling is called from my routine, and then the irq 0 must be
   161                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   162                                  ;       samples played by the Sound Blaster. Note that some samples are
   163                                  ;       discarded in the next code, just for fun!
   164                                  
   165                                  	;in     al, 21h			; disable irq 0!
   166                                  	;or     al, 00000001b
   167                                  	;out    21h, al
   168                                  		
   169 000000B6 E83D03                  	call	ModPlay ; 13/02/2017
   170                                  
   171                                  	;in	al, 21h			; enable irq 0!
   172                                  	;and	al, 11111110b
   173                                  	;out	21h, al
   174                                  
   175 000000B9 B80300                  	mov     ax, 0003h		; Set Text Mode 80x25x16
   176 000000BC CD10                    	int     10h
   177                                  
   178 000000BE E8D00A                  	call	StopPlaying		; STOP!
   179                                  Exit:           
   180                                  	;call   FreeModule		; Free MODule core.
   181                                  error_exit:
   182 000000C1 B8004C                  	mov     ax, 4C00h		; Bye!
   183 000000C4 CD21                    	int     21h
   184                                  here:
   185 000000C6 EBFE                    	jmp	short here
   186                                  
   187                                  pmsg_2017:
   188 000000C8 B80009                  	mov     ax, 0900h		; Prints the Credits Text.
   189                                  	;lea    dx, [msg_2017]
   190 000000CB BA[5C0D]                	mov	dx, msg_2017
   191 000000CE CD21                    	int     21h
   192 000000D0 EBEF                    	jmp	short Exit
   193                                  
   194                                  DetectICH:
   195                                  	; 18/02/2017
   196                                  	; Detech Intel ICH based AC97 Audio Device 
   197 000000D2 E84E01                  	call    pciFindDevice 	; AC97.ASM (PLAYWAV.COM)
   198 000000D5 733F                            jnc     short _1
   199                                  
   200                                  ; couldn't find the audio device!
   201                                  	;push	cs
   202                                  	;pop	ds
   203 000000D7 BA[E000]                        mov     dx, noDevMsg
   204 000000DA B409                            mov     ah, 9
   205 000000DC CD21                            int     21h
   206 000000DE EBE1                            jmp     short error_exit
   207                                  
   208 000000E0 4572726F723A20556E-     noDevMsg db "Error: Unable to find Intel ICH based audio device!",CR,LF,"$"
   208 000000E9 61626C6520746F2066-
   208 000000F2 696E6420496E74656C-
   208 000000FB 204943482062617365-
   208 00000104 6420617564696F2064-
   208 0000010D 6576696365210D0A24 
   209                                  
   210                                  _1:
   211                                  	; 18/02/2017
   212                                  	; eax = BUS/DEV/FN
   213                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   214                                  	; edx = DEV/VENDOR
   215                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   216                                  
   217 00000116 66A3[9A0F]              	mov	[bus_dev_fn], eax
   218 0000011A 668916[9E0F]            	mov	[dev_vendor], edx
   219                                  
   220                                  	; get ICH base address regs for mixer and bus master
   221                                  
   222 0000011F B010                            mov     al, NAMBAR_REG
   223 00000121 E87100                          call    pciRegRead16			; read PCI registers 10-11
   224 00000124 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
   225                                  
   226 00000127 8916[840F]                      mov     [NAMBAR], dx			; save audio mixer base addr
   227                                  
   228 0000012B B014                    	mov     al, NABMBAR_REG
   229 0000012D E86500                          call    pciRegRead16
   230 00000130 83E2FE                          and     dx, IO_ADDR_MASK
   231                                  
   232 00000133 8916[860F]                      mov     [NABMBAR], dx			; save bus master base addr
   233                                  
   234                                  	; 08/05/2024
   235                                  	; 06/11/2023
   236                                  	;; init controller
   237                                  	;; 17/02/2017
   238                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   239                                  	;call	pciRegRead16 ; pciRegRead8
   240                                  	;
   241                                  	;; eax = BUS/DEV/FN/REG
   242                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   243                                  	;; 	00000000CCCCCCCC
   244                                  	;mov	[stats_cmd], dx
   245                                  	;
   246                                  	; 06/11/2023
   247                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   248                                  	;call	pciRegRead32
   249                                  	;
   250                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   251                                          ;mov	[ac97_io_base], dx
   252                                  
   253 00000137 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   254 00000139 E85100                  	call	pciRegRead8 ; 17/02/2017
   255                                  
   256 0000013C 8816[980F]              	mov     [ac97_int_ln_reg], dl
   257                                  
   258                                  ; 12/05/2024 (tuneloop version)
   259                                  %if 0
   260                                  	; 28/11/2016
   261                                  	;mov	bx, 1	; 08/05/2024
   262                                  	xor	dh, dh	; 17/02/2017
   263                                  	; 10/11/2023
   264                                  	;mov	cx, dx
   265                                  	;shl	bx, cl
   266                                  
   267                                  	; 04/11/2023
   268                                  	cli
   269                                  
   270                                  	;not	bx
   271                                  	in	al, 0A1h ; irq 8-15
   272                                          mov	ah, al
   273                                          in	al, 21h  ; irq 0-7 
   274                                  
   275                                  	; 04/11/2023
   276                                  	; save IRQ status
   277                                  	mov	[IRQ_status], ax
   278                                  
   279                                  	; 08/05/2024
   280                                  	;mov	dx, 4D1h			;8259 ELCR1
   281                                          ;in	al, dx
   282                                  	;mov	ah, al
   283                                  	;mov	dx, 4D0h 
   284                                          ;in	al, dx
   285                                  	;;or	ax, bx        
   286                                  	;bts	ax, cx
   287                                  	;mov	dx, 4D0h
   288                                  	;out	dx, al                          ;set level-triggered mode
   289                                  	;mov	al, ah
   290                                  	;mov	dx, 4D1h
   291                                  	;out	dx, al                          ;set level-triggered mode
   292                                  
   293                                  	; 24/11/2016 - Erdogan Tan
   294                                  	;mov	bx, cx
   295                                  	; 10/11/2023
   296                                  	mov	bx, dx
   297                                  	mov	bl, [bx+irq_int]
   298                                  	shl	bx, 2 ; * 4
   299                                  
   300                                  	; set up interrupt vector
   301                                  	; 30/11/2016
   302                                  	push	es
   303                                  	xor	ax, ax
   304                                  	mov	es, ax
   305                                  	; 04/11/2023
   306                                  	; save interrupt vector
   307                                  	mov	ax, [es:bx]
   308                                  	mov	[IRQ_vector], ax
   309                                  	mov	ax, [es:bx+2]
   310                                  	mov	[IRQ_vector+2], ax
   311                                  
   312                                  	mov	word [es:bx], ac97_int_handler
   313                                  	mov	ax, cs
   314                                  	mov	[es:bx+2], ax
   315                                  	pop	es
   316                                  
   317                                  	; 04/11/2023
   318                                  	sti
   319                                  %endif
   320 00000140 C3                      	retn
   321                                  
   322                                  ; 12/05/2024 (tuneloop version)
   323                                  %if 0
   324                                  
   325                                  ac97_int_handler:
   326                                  	; 11/05/2024
   327                                  	; 11/11/2023
   328                                  	; 10/11/2023
   329                                  	; 17/02/2016
   330                                  	push	eax	; 11/11/2023
   331                                  	push	dx
   332                                  	; 05/11/2023
   333                                  	;push	cx
   334                                  	;push	bx
   335                                  	;push	si
   336                                  	;push	di
   337                                  
   338                                  	; 10/11/2023
   339                                  	; EOI at first
   340                                  	mov	al, 20h
   341                                  	test	byte [ac97_int_ln_reg], 8
   342                                  	jz	short _ih_0
   343                                  	out 	0A0h, al ; 20h	; EOI
   344                                  _ih_0:
   345                                  	out	20h, al  ; 20h	; EOI
   346                                  
   347                                  	; 11/11/2023
   348                                  	; 09/11/2023
   349                                  	mov	dx, GLOB_STS_REG
   350                                          add	dx, [NABMBAR]
   351                                  	in	eax, dx
   352                                  	
   353                                  	; 12/05/2024
   354                                  	; 09/11/2023,
   355                                          ;cmp	eax, 0FFFFFFFFh ; -1
   356                                  	;je	short _ih_2
   357                                  	
   358                                  	; 12/05/2024
   359                                  	;test	al, 40h		; PCM Out Interrupt
   360                                  	;jnz	short _ih_1
   361                                  
   362                                  	;test	eax, eax
   363                                  	;jz	short _ih_2
   364                                  	; 12/05/2024
   365                                  	test	ax, PCM_OUT_IRQ+BCIS
   366                                  	jnz	short _ih_1
   367                                  
   368                                   	;mov	dx, GLOB_STS_REG
   369                                          ;add	dx, [NABMBAR]
   370                                  	out	dx, eax
   371                                  	jmp	short _ih_2
   372                                  
   373                                  	; .....
   374                                  	;mov	al, 1
   375                                  	; 10/11/2023
   376                                  	;mov	[tLoop], al  ; 1
   377                                  
   378                                  	;cmp	[inside], al ; 1
   379                                  	;jnb	short _ih_3	; busy
   380                                  
   381                                  	;mov	[inside], al ; 1
   382                                  	;
   383                                  	;; 09/11/2023
   384                                          ;mov	dx, [NABMBAR]
   385                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   386                                  	;in	al, dx
   387                                  	;; 10/11/2023
   388                                  	;;;out	dx, eax
   389                                  	;;out	dx, al		; clear interrupt event
   390                                  	;			; (by writing 1 to same bits)
   391                                  	;
   392                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   393                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   394                                  	;jz	short _ih_2
   395                                  	; .....
   396                                  
   397                                  _ih_1:
   398                                  	; 11/11/2023
   399                                  	push	eax
   400                                  
   401                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   402                                  	;mov	dx, PO_SR_REG
   403                                          ;add	dx, [NABMBAR]
   404                                  	;out	dx, ax
   405                                  
   406                                  	; 10/11/2023
   407                                  	; 28/11/2016 - Erdogan Tan
   408                                  	call	tuneLoop
   409                                  
   410                                  	; 11/11/2023
   411                                  	pop	eax
   412                                  	mov	dx, GLOB_STS_REG
   413                                          add	dx, [NABMBAR]
   414                                  	out	dx, eax
   415                                  _ih_2:
   416                                  	; 11/11/2023
   417                                  	mov	dx, [NABMBAR]
   418                                  	add	dx, PO_SR_REG	; set pointer to Status reg
   419                                  	mov	ax, 1Ch
   420                                  	out	dx, ax
   421                                  
   422                                  ;	; 10/11/2023
   423                                  ;	mov	al, 20h
   424                                  ;	test	byte [ac97_int_ln_reg], 8
   425                                  ;	jz	short _ih_3
   426                                  ;	out 	0A0h, al ; 20h	; EOI
   427                                  ;_ih_3:
   428                                  ;	out	20h, al  ; 20h	; EOI
   429                                  ;_ih_4:
   430                                  	;mov	byte [inside], 0
   431                                  	;pop	di
   432                                  	;pop	si
   433                                  	;pop	bx
   434                                  	;pop	cx
   435                                  	pop	dx
   436                                  	pop	eax ; 11/11/2023
   437                                  	iret
   438                                  
   439                                  %endif
   440                                  
   441                                  ;=============================================================================
   442                                  ;               PCI.ASM
   443                                  ;=============================================================================
   444                                  
   445                                  ; EQUATES
   446                                  
   447                                  ;constants of stuff that seem hard to remember at times.
   448                                  
   449                                  TRUE  EQU 1
   450                                  FALSE EQU 0
   451                                  
   452                                  ENABLED  EQU 1
   453                                  DISABLED EQU 0
   454                                  
   455                                  BIT0  EQU 1
   456                                  BIT1  EQU 2
   457                                  BIT2  EQU 4
   458                                  BIT3  EQU 8
   459                                  BIT4  EQU 10h
   460                                  BIT5  EQU 20h
   461                                  BIT6  EQU 40h
   462                                  BIT7  EQU 80h
   463                                  BIT8  EQU 100h
   464                                  BIT9  EQU 200h
   465                                  BIT10 EQU 400h
   466                                  BIT11 EQU 800h
   467                                  BIT12 EQU 1000h
   468                                  BIT13 EQU 2000h
   469                                  BIT14 EQU 4000h
   470                                  BIT15 EQU 8000h
   471                                  BIT16 EQU 10000h
   472                                  BIT17 EQU 20000h
   473                                  BIT18 EQU 40000h
   474                                  BIT19 EQU 80000h
   475                                  BIT20 EQU 100000h
   476                                  BIT21 EQU 200000h
   477                                  BIT22 EQU 400000h
   478                                  BIT23 EQU 800000h
   479                                  BIT24 EQU 1000000h
   480                                  BIT25 EQU 2000000h
   481                                  BIT26 EQU 4000000h
   482                                  BIT27 EQU 8000000h
   483                                  BIT28 EQU 10000000h
   484                                  BIT29 EQU 20000000h
   485                                  BIT30 EQU 40000000h
   486                                  BIT31 EQU 80000000h
   487                                  
   488                                  ;special characters
   489                                  NUL     EQU 0
   490                                  NULL    EQU 0
   491                                  BELL    EQU 07
   492                                  BS      EQU 08
   493                                  TAB     EQU 09
   494                                  LF      EQU 10
   495                                  CR      EQU 13
   496                                  ESCAPE  EQU 27           ;ESC is a reserved word....
   497                                  
   498                                  
   499                                  ;file stuff
   500                                  READONLY  EQU   BIT0
   501                                  HIDDEN    EQU   BIT1
   502                                  SYSTEM    EQU   BIT2
   503                                  VOLUME    EQU   BIT3         ;ignored for file access
   504                                  DIRECTORY EQU   BIT4         ;must be 0 for file access
   505                                  ARCHIVE   EQU   BIT5
   506                                  SHAREABLE EQU   BIT7         ;for novell networks
   507                                  OPEN	EQU	2		; open existing file
   508                                  CREATE	EQU	1		; create new file
   509                                  
   510                                  
   511                                  ; PCI equates
   512                                  ; PCI function address (PFA)
   513                                  ; bit 31 = 1
   514                                  ; bit 23:16 = bus number     (0-255)
   515                                  ; bit 15:11 = device number  (0-31)
   516                                  ; bit 10:8 = function number (0-7)
   517                                  ; bit 7:0 = register number  (0-255)
   518                                  
   519                                  IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
   520                                  PCI_INDEX_PORT  EQU     0CF8h
   521                                  PCI_DATA_PORT   EQU     0CFCh
   522                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
   523                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
   524                                  
   525                                  PCI_FN0         EQU     0 << 8
   526                                  PCI_FN1         EQU     1 << 8
   527                                  PCI_FN2         EQU     2 << 8
   528                                  PCI_FN3         EQU     3 << 8
   529                                  PCI_FN4         EQU     4 << 8
   530                                  PCI_FN5         EQU     5 << 8
   531                                  PCI_FN6         EQU     6 << 8
   532                                  PCI_FN7         EQU     7 << 8
   533                                  
   534                                  PCI_CMD_REG		EQU	04h		; reg 04, command reg
   535                                   IO_ENA			EQU	BIT0		; i/o decode enable
   536                                   MEM_ENA		EQU	BIT1		; memory decode enable
   537                                   BM_ENA                 EQU     BIT2		; bus master enable
   538                                  
   539                                  ; CODE
   540                                  
   541                                  ; AC97.ASM
   542                                  ; PCI device register reader/writers.
   543                                  ; NASM version: Erdogan Tan (29/11/2016)
   544                                  ; 		Last Update: 17/02/2017
   545                                  
   546                                  ;===============================================================
   547                                  ; 8/16/32bit PCI reader
   548                                  ;
   549                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   550                                  ;           BIT30 set if 32 bit access requested
   551                                  ;           BIT29 set if 16 bit access requested
   552                                  ;           otherwise defaults to 8bit read
   553                                  ;
   554                                  ; Exit:  DL,DX,EDX register data depending on requested read size
   555                                  ;
   556                                  ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
   557                                  ;	or pciRegRead32, listed below.
   558                                  ;
   559                                  ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
   560                                  ;	 number.  Likewise, don't do 16bit reads from non word aligned reg #
   561                                  ; 
   562                                  pciRegRead:
   563 00000141 6653                    	push	ebx
   564 00000143 51                      	push	cx
   565 00000144 6689C3                          mov     ebx, eax                        ; save eax, dh
   566 00000147 88F1                            mov     cl, dh
   567 00000149 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   568 0000014F 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   569 00000155 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   570                                  
   571 00000157 BAF80C                          mov     dx, PCI_INDEX_PORT
   572 0000015A 66EF                            out     dx, eax                         ; write PCI selector
   573                                  
   574 0000015C BAFC0C                          mov     dx, PCI_DATA_PORT
   575 0000015F 88D8                            mov     al, bl
   576 00000161 2403                            and     al, 3                           ; figure out which port to
   577 00000163 00C2                            add     dl, al                          ; read to
   578                                  
   579 00000165 66ED                    	in      eax, dx                         ; do 32bit read
   580 00000167 66F7C300000080                  test    ebx, PCI32
   581 0000016E 7403                            jz      short _pregr1
   582                                  
   583 00000170 6689C2                          mov     edx, eax                        ; return 32bits of data
   584                                  _pregr1:
   585 00000173 89C2                    	mov     dx, ax                          ; return 16bits of data
   586 00000175 66F7C3000000C0                  test    ebx, PCI32+PCI16
   587 0000017C 7502                            jnz     short _pregr2
   588 0000017E 88CE                            mov     dh, cl                          ; restore dh for 8 bit read
   589                                  _pregr2:
   590 00000180 6689D8                          mov     eax, ebx                        ; restore eax
   591 00000183 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   592 00000189 59                      	pop	cx
   593 0000018A 665B                    	pop	ebx
   594 0000018C C3                      	retn
   595                                  
   596                                  pciRegRead8:
   597 0000018D 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
   598 00000193 EBAC                            jmp     short pciRegRead		; call generic PCI access
   599                                  
   600                                  pciRegRead16:
   601 00000195 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit read size
   602 0000019B 660D00000040                    or      eax, PCI16			; call generic PCI access
   603 000001A1 EB9E                            jmp     short pciRegRead
   604                                  
   605                                  pciRegRead32:
   606 000001A3 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit read size
   607 000001A9 660D00000080                    or      eax, PCI32			; call generic PCI access
   608 000001AF EB90                            jmp     short pciRegRead
   609                                  
   610                                  ;===============================================================
   611                                  ; 8/16/32bit PCI writer
   612                                  ;
   613                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   614                                  ;           BIT31 set if 32 bit access requested
   615                                  ;           BIT30 set if 16 bit access requested
   616                                  ;           otherwise defaults to 8bit read
   617                                  ;        DL/DX/EDX data to write depending on size
   618                                  ;
   619                                  ;
   620                                  ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
   621                                  ; 	or pciRegWrite32 as detailed below.
   622                                  ;
   623                                  ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
   624                                  ;	 number.  Likewise, don't do 16bit writes from non word aligned reg #
   625                                  ;
   626                                  pciRegWrite:
   627 000001B1 6653                    	push	ebx
   628 000001B3 51                      	push	cx
   629 000001B4 6689C3                          mov     ebx, eax                        ; save eax, dx
   630 000001B7 89D1                            mov     cx, dx
   631 000001B9 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   632 000001BF 6625FFFFFFBF                    and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   633 000001C5 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   634                                  
   635 000001C7 BAF80C                          mov     dx, PCI_INDEX_PORT
   636 000001CA 66EF                            out     dx, eax                         ; write PCI selector
   637                                  
   638 000001CC BAFC0C                          mov     dx, PCI_DATA_PORT
   639 000001CF 88D8                            mov     al, bl
   640 000001D1 2403                            and     al, 3                           ; figure out which port to
   641 000001D3 00C2                            add     dl, al                          ; write to
   642                                  
   643 000001D5 6689D0                          mov     eax, edx                        ; put data into eax
   644 000001D8 89C8                            mov     ax, cx
   645                                  
   646 000001DA EE                              out     dx, al
   647 000001DB 66F7C3000000C0                  test    ebx, PCI16+PCI32                ; only 8bit access? bail
   648 000001E2 740C                            jz      short _pregw1
   649                                  
   650 000001E4 EF                              out     dx, ax                          ; write 16 bit value
   651 000001E5 66F7C300000040                  test    ebx, PCI16                      ; 16bit requested?  bail
   652 000001EC 7502                            jnz     short _pregw1
   653                                  
   654 000001EE 66EF                            out     dx, eax                         ; write full 32bit
   655                                  _pregw1:
   656 000001F0 6689D8                          mov     eax, ebx                        ; restore eax
   657 000001F3 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   658 000001F9 89CA                            mov     dx, cx                          ; restore dx
   659 000001FB 59                      	pop	cx
   660 000001FC 665B                    	pop	ebx
   661 000001FE C3                      	ret
   662                                  
   663                                  pciRegWrite8:
   664 000001FF 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   665 00000205 EBAA                            jmp     short pciRegWrite		; call generic PCI access
   666                                  
   667                                  pciRegWrite16:
   668 00000207 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   669 0000020D 660D00000040                    or      eax, PCI16			; call generic PCI access
   670 00000213 EB9C                            jmp     short pciRegWrite
   671                                  
   672                                  pciRegWrite32:
   673 00000215 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   674 0000021B 660D00000080                    or      eax, PCI32			; call generic PCI access
   675 00000221 EB8E                            jmp     short pciRegWrite
   676                                  
   677                                  ; AC97.ASM (PLAYWAV.COM)
   678                                  ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   679                                  ;===============================================================
   680                                  ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   681                                  ;
   682                                  ;  ENTRY: none
   683                                  ;; Entry: EAX=Device+Vendor ID
   684                                  ;
   685                                  ;  Exit: EAX=PCI address if device found
   686                                  ;	 EDX=Device+Vendor ID
   687                                  ;        CY clear if found, set if not found. EAX invalid if CY set.
   688                                  ;
   689                                  ; [old stackless] Destroys: ebx, esi, edi, cl
   690                                  ;
   691                                  pciFindDevice:
   692                                  	;push	cx
   693                                  	;push	eax ; *
   694                                  	;push	esi
   695                                  	;push	edi
   696                                  
   697                                   	;mov     esi, eax                ; save off vend+device ID
   698                                  
   699                                  	; 17/02/2017
   700 00000223 BE[850E]                	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   701 00000226 B91500                  	mov	cx, valid_id_count
   702                                  pfd_0:
   703 00000229 66BF00FFFF7F                   	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   704                                  nextPCIdevice:
   705 0000022F 6681C700010000                  add     edi, 100h
   706 00000236 6681FF00F8FF80                  cmp     edi, 80FFF800h		; scanned all devices?
   707                                          ;stc
   708                                          ;je 	short PCIScanExit       ; not found
   709 0000023D 720D                    	jb	short pfd_1
   710 0000023F 66BF00000080            	mov     edi, 80000000h
   711 00000245 83C604                  	add	si, 4 ; scan for next device ID
   712 00000248 E202                    	loop	pfd_1	 
   713 0000024A F9                      	stc	
   714                                  	;jmp 	short PCIScanExit
   715 0000024B C3                      	retn
   716                                  pfd_1:
   717 0000024C 6689F8                          mov     eax, edi                ; read PCI registers
   718 0000024F E851FF                          call    pciRegRead32
   719                                          ;cmp    edx, esi                ; found device?
   720 00000252 663B14                          cmp	edx, dword [si]
   721 00000255 75D8                    	jne     short nextPCIdevice
   722                                          ;clc
   723                                  PCIScanExit:
   724                                  	;pushf
   725 00000257 66B800000080            	mov	eax, BIT31
   726 0000025D 66F7D0                  	not	eax
   727 00000260 6621F8                  	and	eax, edi		; return only bus/dev/fn #
   728                                  	;popf
   729                                  
   730                                  	;pop	edi
   731                                  	;pop	esi
   732                                  	;pop	edx ; *
   733                                  	;pop	cx
   734 00000263 C3                      	retn
   735                                  
   736                                  ;=============================================================================
   737                                  ;               CODEC.ASM
   738                                  ;=============================================================================
   739                                  
   740                                  ; EQUATES
   741                                  
   742                                  ;Codec registers.
   743                                  ;
   744                                  ;Not all codecs are created equal. Refer to the spec for your specific codec.
   745                                  ;
   746                                  ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   747                                  ;is defined by the OEM.  
   748                                  ;
   749                                  ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   750                                  ;
   751                                  
   752                                  ; each codec/mixer register is 16bits
   753                                  
   754                                  CODEC_RESET_REG                 equ     00      ; reset codec
   755                                  CODEC_MASTER_VOL_REG            equ     02      ; master volume
   756                                  CODEC_HP_VOL_REG                equ     04      ; headphone volume
   757                                  CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   758                                  CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   759                                  CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   760                                  CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   761                                  CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   762                                  CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   763                                  CODEC_CD_VOL_REG                equ     12h     ; CD volume
   764                                  CODEC_VID_VOL_REG               equ     14h     ; video volume
   765                                  CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   766                                  CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   767                                  CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   768                                  CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   769                                  CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   770                                  CODEC_GP_REG                    equ     20h     ; general purpose
   771                                  CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   772                                  ; 24h is reserved
   773                                  CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   774                                  CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   775                                  CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   776                                  CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   777                                  CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   778                                  CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   779                                  CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   780                                  CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   781                                  
   782                                  ; registers 36-7a are reserved on the ICH
   783                                  
   784                                  CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   785                                  CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   786                                  
   787                                  ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   788                                  ; the AC97 link to the codec, which I think is a little weird.  Looks like
   789                                  ; the ICH makes it so you don't need a fully functional codec to play audio?
   790                                  ;
   791                                  ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   792                                  ; set of registers, ie 80h-feh
   793                                  
   794                                  PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   795                                  SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   796                                  
   797                                  SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   798                                  
   799                                  ; ----------------------------------------------------------------------------
   800                                  ; 17/02/2017
   801                                  PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   802                                  AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   803                                  
   804                                  ; ----------------------------------------------------------------------------
   805                                  ; ICH2AC97.INC
   806                                  ; ----------------------------------------------------------------------------
   807                                  
   808                                  ; PCI stuff
   809                                  
   810                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   811                                  
   812                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   813                                  
   814                                  ; 08/05/2024
   815                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   816                                  SIS_VID		equ	1039h
   817                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   818                                  AMD_VID		equ	1022h
   819                                  
   820                                  ICH_DID         equ     2415h           ; ICH device ID
   821                                  ICH0_DID        equ     2425h           ; ICH0
   822                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   823                                                                          ; they all should be compatible.
   824                                  ; 08/05/2024
   825                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   826                                  ICH3_DID	equ     2485h           ; ICH3
   827                                  ICH4_DID        equ     24C5h           ; ICH4
   828                                  ICH5_DID	equ     24D5h           ; ICH5 
   829                                  ICH6_DID	equ     266Eh           ; ICH6
   830                                  ESB6300_DID	equ     25A6h           ; 6300ESB
   831                                  ESB631X_DID	equ     2698h           ; 631XESB
   832                                  ICH7_DID	equ	27DEh		; ICH7
   833                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   834                                  MX82440_DID	equ	7195h
   835                                  SI7012_DID	equ	7012h
   836                                  NFORCE_DID	equ	01B1h
   837                                  NFORCE2_DID	equ	006Ah
   838                                  AMD8111_DID	equ	746Dh
   839                                  AMD768_DID	equ	7445h
   840                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   841                                  CK804_DID	equ	0059h
   842                                  MCP04_DID	equ	003Ah
   843                                  CK8_DID		equ	008Ah
   844                                  NFORCE3_DID	equ	00DAh
   845                                  CK8S_DID	equ	00EAh
   846                                  
   847                                  NAMBAR_REG      equ     10h             ; native audio mixer BAR
   848                                   NAM_SIZE       equ     256             ; 256 bytes required.
   849                                  
   850                                  NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   851                                   NABM_SIZE      equ     64              ; 64 bytes
   852                                  
   853                                  ; BUS master registers, accessed via NABMBAR+offset
   854                                  
   855                                  ; ICH supports 3 different types of register sets for three types of things
   856                                  ; it can do, thus:
   857                                  ;
   858                                  ; PCM in (for recording) aka PI
   859                                  ; PCM out (for playback) aka PO
   860                                  ; MIC in (for recording) aka MC
   861                                  
   862                                  PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   863                                  PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   864                                  MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   865                                  
   866                                  ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   867                                  ; contents of the .WAV file we're going to play.  Each entry is 8 bytes long
   868                                  ; (more on that later) and can contain 32 entries total, so each BAR is
   869                                  ; 256 bytes in length, thus:
   870                                  
   871                                  BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   872                                  INDEX_MASK              equ     31      ; indexes must be 0-31
   873                                  
   874                                  
   875                                  
   876                                  PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   877                                  PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   878                                  MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   879                                  ;8bit read only
   880                                  ; each current index value is simply a pointer showing us which buffer
   881                                  ; (0-31) the codec is currently processing.  Once this counter hits 31, it
   882                                  ; wraps back to 0.
   883                                  ; this can be handy to know, as once it hits 31, we're almost out of data to
   884                                  ; play back or room to record!
   885                                  
   886                                  
   887                                  PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   888                                  PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   889                                  MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   890                                  ;8bit read/write
   891                                  ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   892                                  ; number to stop on after processing.  It could be very nasty to play audio
   893                                  ; from buffers that aren't filled with the audio we want to play.
   894                                  
   895                                  
   896                                  PI_SR_REG               equ     6       ; PCM in Status register
   897                                  PO_SR_REG               equ     16h     ; PCM out Status register
   898                                  MC_SR_REG               equ     26h     ; MIC in Status register
   899                                  ;16bit read/write
   900                                  ; status registers.  Bitfields follow:
   901                                  
   902                                  FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   903                                  
   904                                  BCIS                    equ     BIT3    ; buffer completion interrupt status.
   905                                                                          ; Set whenever the last sample in ANY
   906                                                                          ; buffer is finished.  Bit is only
   907                                                                          ; set when the Interrupt on Complete
   908                                                                          ; (BIT4 of control reg) is set.
   909                                  
   910                                  LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   911                                                                          ; the last buffer in the buffer list.
   912                                                                          ; Will fire an interrupt if IOC bit is
   913                                                                          ; set. Probably set after the last
   914                                                                          ; sample in the last buffer is
   915                                                                          ; processed.  W1TC
   916                                  
   917                                                                          ; 
   918                                  CELV                    equ     BIT1    ; Current buffer == last valid.
   919                                                                          ; Bit is RO and remains set until LVI is
   920                                                                          ; cleared.  Probably set up the start
   921                                                                          ; of processing for the last buffer.
   922                                  
   923                                  
   924                                  DCH                     equ     BIT0    ; DMA controller halted.
   925                                                                          ; set whenever audio stream is stopped
   926                                                                          ; or something else goes wrong.
   927                                  
   928                                  PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   929                                  PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   930                                  MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   931                                  ;16bit read only
   932                                  ; position in current buffer regs show the number of dwords left to be
   933                                  ; processed in the current buffer.
   934                                  ; 
   935                                  
   936                                  PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   937                                  PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   938                                  MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   939                                  ;8bit, read only
   940                                  ; Prefetched index value register.
   941                                  ; tells which buffer number (0-31) has be prefetched.  I'd imagine this
   942                                  ; value follows the current index value fairly closely. (CIV+1)
   943                                  ;
   944                                  
   945                                  PI_CR_REG               equ     0bh     ; PCM in Control Register
   946                                  PO_CR_REG               equ     1bh     ; PCM out Control Register
   947                                  MC_CR_REG               equ     2bh     ; MIC in Control Register
   948                                  ; 8bit
   949                                  ; Control register *MUST* only be accessed as an 8bit value.
   950                                  ; Control register.  See bitfields below.
   951                                  ;
   952                                  
   953                                  IOCE                    equ     BIT4    ; interrupt on complete enable.
   954                                                                          ; set this bit if you want an intrtpt
   955                                                                          ; to fire whenever LVBCI is set.
   956                                  FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   957                                                                          ; whenever there is a FIFO (over or
   958                                                                          ; under) error.
   959                                  LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   960                                                                          ; set if you want an interrupt to fire
   961                                                                          ; whenever the completion of the last
   962                                                                          ; valid buffer.
   963                                  RR                      equ     BIT1    ; reset registers.  Nukes all regs
   964                                                                          ; except bits 4:2 of this register.
   965                                                                          ; Only set this bit if BIT 0 is 0
   966                                  RPBM                    equ     BIT0    ; Run/Pause
   967                                                                          ; set this bit to start the codec!
   968                                  
   969                                  
   970                                  GLOB_CNT_REG            equ     2ch     ; Global control register
   971                                  SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   972                                                                          ; interrupt enable.  Not used here.
   973                                  PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   974                                  ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   975                                  ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   976                                                                          ; registers preserved, bit self clears
   977                                  ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   978                                                                          ; reset all registers.  Not self clearing
   979                                  
   980                                  GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   981                                                                          ; set if you want an interrupt to
   982                                                                          ; fire upon ANY of the bits in the
   983                                                                          ; GPI (general pursose inputs?) not used.
   984                                  
   985                                  GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   986                                  
   987                                  MD3                     equ     BIT17   ; modem powerdown status (yawn)
   988                                  AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   989                                  RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   990                                  BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   991                                  BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   992                                  BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   993                                  SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   994                                  PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   995                                  SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   996                                  PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   997                                                                          ; software must check these bits before
   998                                                                          ; starting the codec!
   999                                  MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
  1000                                  PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
  1001                                  PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
  1002                                  MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
  1003                                  MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
  1004                                  GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
  1005                                                                          ; BIT0 of slot 12 also reflects this.
  1006                                  
  1007                                  
  1008                                  ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
  1009                                  CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
  1010                                                                          ; self clearing
  1011                                  ;
  1012                                  ; Buffer Descriptors List
  1013                                  ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
  1014                                  ; descriptors, each 8 bytes in length.  Bytes 0-3 of a descriptor entry point
  1015                                  ; to a chunk of memory to either play from or record to.  Bytes 4-7 of an
  1016                                  ; entry describe various control things detailed below.
  1017                                  ; 
  1018                                  ; Buffer pointers must always be aligned on a Dword boundry.
  1019                                  ;
  1020                                  ;
  1021                                  
  1022                                  IOC                     equ     BIT31   ; Fire an interrupt whenever this
  1023                                                                          ; buffer is complete.
  1024                                  
  1025                                  BUP                     equ     BIT30   ; Buffer Underrun Policy.
  1026                                                                          ; if this buffer is the last buffer
  1027                                                                          ; in a playback, fill the remaining
  1028                                                                          ; samples with 0 (silence) or not.
  1029                                                                          ; It's a good idea to set this to 1
  1030                                                                          ; for the last buffer in playback,
  1031                                                                          ; otherwise you're likely to get a lot
  1032                                                                          ; of noise at the end of the sound.
  1033                                  
  1034                                  ;
  1035                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1036                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1037                                  ; Luckily for us, that's the same format as .wav files.
  1038                                  ;
  1039                                  ; A value of FFFF is 65536 samples.  Running at 44.1Khz, that's just about
  1040                                  ; 1.5 seconds of sample time.  FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1041                                  ;
  1042                                  ; A value of 0 in these bits means play no samples.
  1043                                  ;
  1044                                  
  1045                                  ; CODE
  1046                                  
  1047                                  ; AC97.ASM
  1048                                  
  1049                                  ; codec configuration code.  Not much here really.
  1050                                  ; NASM version: Erdogan Tan (29/11/2016)
  1051                                  
  1052                                  ; enable codec, unmute stuff, set output rate to 44.1
  1053                                  ; entry: ax = desired sample rate
  1054                                  ;
  1055                                  
  1056                                  ; 08/05/2024
  1057                                  %if 0
  1058                                  
  1059                                  codecConfig:
  1060                                  	; 17/02/2017 
  1061                                  	; 07/11/2016 (Erdogan Tan)
  1062                                  	PORT_NABM_GLB_CTRL_STAT equ 60h
  1063                                  
  1064                                  	;mov    dx, [NAMBAR]               	; mixer base address
  1065                                  	;add	dx, CODEC_EXT_AUDIO_REG	       	; 28h  	  
  1066                                  	;in	ax, dx
  1067                                  	;and	ax, 1
  1068                                  	;jnz	short _ssr
  1069                                  	;pop	ax
  1070                                  	;jmp	short cconf_1
  1071                                  
  1072                                  _ssr:
  1073                                  	mov    	dx, [NAMBAR]               	
  1074                                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
  1075                                  	in     	ax, dx
  1076                                  	or	ax, 1
  1077                                  	out	dx, ax 				; Enable variable rate audio
  1078                                  
  1079                                          call    delay1_4ms
  1080                                          call    delay1_4ms
  1081                                          call    delay1_4ms
  1082                                          call    delay1_4ms
  1083                                  
  1084                                  	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1085                                  
  1086                                  	mov    	dx, [NAMBAR]               	
  1087                                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
  1088                                  	out	dx, ax 				; out sample rate
  1089                                  		
  1090                                  	;mov    dx, [NAMBAR]               	
  1091                                  	;add    dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
  1092                                  	;out	dx, ax 
  1093                                  
  1094                                          call    delay1_4ms
  1095                                          call    delay1_4ms
  1096                                          call    delay1_4ms
  1097                                          call    delay1_4ms
  1098                                  
  1099                                  ;cconf_1:
  1100                                  	mov     dx, [NAMBAR]			; mixer base address
  1101                                          add     dx, CODEC_RESET_REG  		; reset register
  1102                                          mov	ax, 42
  1103                                  	out     dx, ax                          ; reset
  1104                                  
  1105                                  	mov     dx, [NABMBAR]			; bus master base address
  1106                                          add     dx, PORT_NABM_GLB_CTRL_STAT
  1107                                          mov	ax, 2
  1108                                  	out     dx, ax                         
  1109                                  
  1110                                  	mov	cx, 7
  1111                                  _100ms:
  1112                                  	push	cx
  1113                                          call    delay1_4ms
  1114                                          call    delay1_4ms
  1115                                          call    delay1_4ms
  1116                                          call    delay1_4ms
  1117                                  	pop	cx
  1118                                  	loop	_100ms	
  1119                                  	
  1120                                    	mov     dx, [NAMBAR]
  1121                                    	add     dx, CODEC_MASTER_VOL_REG        ;02h 
  1122                                    	xor     ax, ax ; ; volume attenuation = 0 (max. volume)
  1123                                    	out     dx, ax
  1124                                   
  1125                                    	mov     dx, [NAMBAR]
  1126                                    	add     dx, CODEC_MASTER_MONO_VOL_REG   ;06h 
  1127                                    	;xor    ax, ax
  1128                                    	out     dx, ax
  1129                                  
  1130                                    	mov     dx, [NAMBAR]
  1131                                    	add     dx, CODEC_PCBEEP_VOL_REG        ;0Ah 
  1132                                    	;xor    ax, ax
  1133                                    	out     dx, ax
  1134                                  
  1135                                    	mov     dx, [NAMBAR]
  1136                                    	add     dx, CODEC_PCM_OUT_REG		;18h 
  1137                                    	;xor    ax, ax
  1138                                    	out     dx, ax
  1139                                  
  1140                                          call    delay1_4ms
  1141                                          call    delay1_4ms
  1142                                          call    delay1_4ms
  1143                                          call    delay1_4ms
  1144                                  
  1145                                          retn
  1146                                  
  1147                                  %else
  1148                                  	; 12/05/2024
  1149                                  	; 08/05/2024
  1150                                  	; (ac97_vra.asm, 19/11/2023, Erdogan Tan, playwav3.asm) 
  1151                                  codecConfig:
  1152                                  	; 02/12/2023
  1153                                  	; 26/11/2023
  1154                                  	; 21/11/2023
  1155                                  	; 20/11/2023
  1156                                  	; 19/11/2023 (TRDOS 386 v2.0.7)
  1157                                  	; 15/11/2023
  1158                                  	; 04/11/2023
  1159                                  	; 17/02/2017 
  1160                                  	; 07/11/2016 (Erdogan Tan)
  1161                                  	;PORT_NABM_GLB_CTRL_STAT equ 60h
  1162                                  
  1163                                  	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
  1164                                   	; 'AC97_DEF.H'
  1165                                  	;AC97_EXTENDED_STATUS equ 002Ah
  1166                                  	AC97_EA_SPDIF	equ 0002h
  1167                                  	AC97_EA_VRA	equ 0001h
  1168                                  	; 04/11/2023
  1169                                  	ICH_PO_CR_RESET equ 0002h  ; reset codec
  1170                                  	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
  1171                                  	ICH_PCM_246_MASK equ 300000h ; 6 channels
  1172                                  
  1173                                  	; 08/05/2024
  1174                                  	; 11/11/2023
  1175                                  	CTRL_ST_CREADY	equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  1176                                  	CODEC_REG_POWERDOWN equ	26h
  1177                                  
  1178                                  	; 04/11/2023
  1179                                  init_ac97_controller:
  1180 00000264 66A1[9A0F]              	mov	eax, [bus_dev_fn]
  1181 00000268 B004                    	mov	al, PCI_CMD_REG
  1182 0000026A E828FF                  	call	pciRegRead16		; read PCI command register
  1183 0000026D 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1184 00000270 E894FF                  	call	pciRegWrite16
  1185                                  
  1186                                  ; 02/12/2023
  1187                                  	;call	delay_100ms ; 29/05/2017
  1188                                  
  1189                                  	; 02/12/2023
  1190 00000273 E81F09                  	call	delay1_4ms
  1191 00000276 E81C09                  	call	delay1_4ms
  1192 00000279 E81909                  	call	delay1_4ms
  1193 0000027C E81609                  	call	delay1_4ms
  1194                                  
  1195                                  init_ac97_codec:
  1196                                  	; 18/11/2023
  1197 0000027F BD2800                  	mov	bp, 40
  1198                                  _initc_1:
  1199                                  	; 11/11/2023
  1200                                  	; (TRDOS 386 v2.0.5, 'audio.s')
  1201 00000282 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1202 00000285 0316[860F]              	add	dx, [NABMBAR]
  1203 00000289 66ED                    	in	eax, dx
  1204                                  
  1205                                  	; 02/12/2023
  1206 0000028B E80709                  	call	delay1_4ms
  1207                                  
  1208                                  	; ?
  1209                                  	;; 15/11/2023
  1210                                  	;;mov	cx, 40
  1211                                  	;mov	bp, 40 ; 18/11/2023
  1212                                  ;_initc_1:
  1213 0000028E BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1214 00000291 0316[860F]              	add	dx, [NABMBAR]
  1215 00000295 66ED                    	in	eax, dx
  1216                                  
  1217                                  	; 02/12/2023
  1218 00000297 E8FB08                  	call	delay1_4ms
  1219                                  
  1220 0000029A 6683F8FF                	cmp	eax, 0FFFFFFFFh ; -1
  1221                                  	;je	short init_ac97_codec_err1
  1222                                  	; 15/11/2023
  1223 0000029E 7508                    	jne	short _initc_3
  1224                                  _initc_2:
  1225                                  	;dec	cx
  1226 000002A0 4D                      	dec	bp	; 18/11/2023
  1227                                  	;jz	short init_ac97_codec_err1
  1228                                  	; 19/11/2023
  1229 000002A1 7412                    	jz	short _ac97_codec_ready
  1230                                  
  1231 000002A3 E84501                  	call	delay_100ms
  1232 000002A6 EBDA                    	jmp	short _initc_1
  1233                                  _initc_3:
  1234 000002A8 66A900030010            	test	eax, CTRL_ST_CREADY
  1235 000002AE 7505                    	jnz	short _ac97_codec_ready
  1236                                  
  1237 000002B0 E8B800                  	call	reset_ac97_codec
  1238                                  	; 11/11/2023
  1239                                  	;jc	short init_ac97_codec_err2
  1240                                  	; 15/11/2023
  1241                                  	;jc	short _initc_2
  1242                                  	; 26/11/2023
  1243 000002B3 EBEB                    	jmp	short _initc_2
  1244                                  
  1245                                  _ac97_codec_ready:
  1246 000002B5 8B16[840F]              	mov	dx, [NAMBAR]
  1247                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1248 000002B9 EF                      	out	dx, ax
  1249                                  
  1250 000002BA E82E01                  	call	delay_100ms
  1251                                  
  1252                                  	; 19/11/2023
  1253 000002BD 09ED                    	or	bp, bp
  1254 000002BF 751C                    	jnz	short _ac97_codec_init_ok
  1255                                  
  1256 000002C1 6631C0                  	xor	eax, eax ; 0
  1257 000002C4 8B16[840F]              	mov	dx, [NAMBAR]
  1258 000002C8 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1259 000002CB EF                      	out	dx, ax
  1260                                  	
  1261                                  	; 19/11/2023
  1262                                  	; wait for 1 second
  1263                                  	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1264 000002CC B90A00                  	mov	cx, 10
  1265                                  _ac97_codec_rloop:
  1266                                  	;call	delay1_4ms
  1267                                  	;call	delay1_4ms
  1268                                  	;call	delay1_4ms
  1269                                  	;call	delay1_4ms
  1270 000002CF E81901                  	call	delay_100ms
  1271                                  	;mov	dx, [NAMBAR]
  1272                                  	;add	dx, CODEC_REG_POWERDOWN
  1273 000002D2 ED                      	in	ax, dx	
  1274 000002D3 83E00F                  	and	ax, 0Fh
  1275 000002D6 3C0F                    	cmp	al, 0Fh
  1276 000002D8 7403                    	je	short _ac97_codec_init_ok
  1277 000002DA E2F3                    	loop	_ac97_codec_rloop 
  1278                                  
  1279                                  	; 12/05/2024
  1280                                  	; cf = 1
  1281                                  init_ac97_codec_err1:
  1282                                  	;stc	; 12/05/2024
  1283                                  init_ac97_codec_err2:
  1284 000002DC C3                      	retn
  1285                                  
  1286                                  _ac97_codec_init_ok:
  1287                                          ; 11/11/2023
  1288                                  	;mov	al, 2 ; force set 16-bit 2-channel PCM
  1289                                  	;mov	dx, GLOB_CNT_REG ; 2Ch
  1290                                  	;add	dx, [NABMBAR]
  1291                                  	;out	dx, eax
  1292                                  
  1293                                  	;;call	delay1_4ms
  1294                                  
  1295 000002DD E85600                  	call 	reset_ac97_controller
  1296                                  
  1297                                  	; 11/11/2023
  1298 000002E0 E8B208                  	call	delay1_4ms
  1299                                  	; 21/11/2023 - temporary
  1300 000002E3 E80501                  	call	delay_100ms
  1301                                  
  1302                                  	;call 	setup_ac97_codec
  1303                                  
  1304                                  setup_ac97_codec:
  1305                                  	; 08/05/2028
  1306                                  	; [sample_rate] = 22050
  1307                                  	; 12/11/2023
  1308                                  	;cmp	word [sample_rate], 48000
  1309                                  	;je	short skip_rate
  1310                                  
  1311                                  ; 11/11/2023
  1312                                  ; 05/11/2023
  1313                                  ;%if 1
  1314                                  	AC97_EA_VRA equ BIT0 ; 11/11/2023
  1315                                  
  1316                                  	; 11/11/2023
  1317 000002E6 8B16[840F]              	mov    	dx, [NAMBAR]               	
  1318 000002EA 83C22A                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
  1319 000002ED ED                      	in     	ax, dx
  1320                                  
  1321                                  	; 02/12/2023
  1322 000002EE E8A408                  	call	delay1_4ms
  1323                                  
  1324 000002F1 24FD                    	and	al, ~BIT1 ; Clear DRA
  1325 000002F3 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1326 000002F5 EF                      	out	dx, ax			; Enable variable rate audio
  1327                                  	
  1328 000002F6 B90A00                  	mov	cx, 10
  1329                                  check_vra:
  1330 000002F9 E8EF00                  	call	delay_100ms
  1331                                  
  1332                                  	; 11/11/2023
  1333 000002FC ED                      	in	ax, dx
  1334 000002FD A801                    	test	al, AC97_EA_VRA ; 1
  1335 000002FF 750A                    	jnz	short set_rate
  1336                                  
  1337                                  	; 11/11/2023
  1338 00000301 E2F6                    	loop	check_vra
  1339                                  
  1340                                  	; 13/11/2023
  1341                                  	;mov	byte [VRA], 0
  1342                                  	; 08/05/2024
  1343 00000303 C706[E464]80BB          	mov	word [sample_rate], 48000
  1344 00000309 EB0E                    	jmp	short skip_rate	
  1345                                  
  1346                                  	; 12/11/2023
  1347                                  	;pop	ax ; discard return address to the caller
  1348                                  	;mov	dx, msg_no_vra
  1349                                  	;jmp	vra_err
  1350                                  
  1351                                  set_rate:
  1352 0000030B A1[E464]                	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1353                                  	; 08/05/2024
  1354                                  	; ax = 22050 (Hz)
  1355                                  
  1356 0000030E 8B16[840F]              	mov    	dx, [NAMBAR]               	
  1357 00000312 83C22C                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
  1358 00000315 EF                      	out	dx, ax 			; PCM Front/Center Output Sample Rate
  1359                                  
  1360 00000316 E8D200                  	call	delay_100ms
  1361                                  
  1362                                  	; 12/11/2023
  1363                                  skip_rate:
  1364                                  	; 11/11/2023 (temporary)
  1365                                  
  1366                                  	;mov   	dx, [NAMBAR]               	
  1367                                  	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
  1368                                  	;out	dx, ax 			; PCM Surround Output Sample Rate
  1369                                  
  1370                                  	;call	delay_100ms
  1371                                  
  1372                                  	;mov   	dx, [NAMBAR]               	
  1373                                  	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
  1374                                  	;out	dx, ax 			; PCM LFE Output Sample Rate
  1375                                  
  1376                                  	;call	delay_100ms
  1377                                  
  1378                                  	; 05/11/2023 (temporary)
  1379                                  	;mov	dx, [NAMBAR]               	
  1380                                  	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
  1381                                  	;out	dx, ax 			; PCM Input Sample Rate
  1382                                  	;
  1383                                  	;call	delay_100ms
  1384                                  
  1385 00000319 B80202                  	mov	ax, 0202h
  1386 0000031C A2[A30F]                	mov	[volume], al ; 29
  1387 0000031F 8B16[840F]              	mov     dx, [NAMBAR]
  1388 00000323 83C202                    	add     dx, CODEC_MASTER_VOL_REG	;02h 
  1389 00000326 EF                      	out     dx, ax
  1390                                  
  1391                                  	; 11/11/2023
  1392                                          ;call	delay1_4ms
  1393                                          ;call	delay1_4ms
  1394                                          ;call	delay1_4ms
  1395                                          ;call	delay1_4ms
  1396                                   	;
  1397                                    	;mov	dx, [NAMBAR]
  1398                                    	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
  1399                                    	;out	dx, ax
  1400                                  
  1401                                  	; 11/11/2023
  1402                                          ;call	delay1_4ms
  1403                                          ;call	delay1_4ms
  1404                                          ;call	delay1_4ms
  1405                                          ;call	delay1_4ms
  1406                                  	;
  1407                                  	;mov	ax, 02h
  1408                                    	;mov	dx, [NAMBAR]
  1409                                    	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
  1410                                    	;out	dx, ax
  1411                                  
  1412                                  	; 20/11/2023
  1413                                          ;call	delay1_4ms
  1414                                          ;call	delay1_4ms
  1415                                          ;call	delay1_4ms
  1416                                          ;call	delay1_4ms
  1417                                  	; 21/11/2023 temporary
  1418 00000327 E8C100                  	call	delay_100ms
  1419                                  
  1420                                  	;mov	ax, 0202h
  1421 0000032A 8B16[840F]                	mov     dx, [NAMBAR]
  1422 0000032E 83C218                    	add     dx, CODEC_PCM_OUT_REG		;18h 
  1423 00000331 EF                        	out     dx, ax
  1424                                  
  1425                                  	; 20/11/2023
  1426                                          ;call	delay1_4ms
  1427                                          ;call	delay1_4ms
  1428                                          ;call	delay1_4ms
  1429                                          ;call	delay1_4ms
  1430                                  	; 21/11/2023 - temporary
  1431 00000332 E8B600                  	call	delay_100ms
  1432                                  
  1433                                  	; 11/11/2023
  1434                                  	;mov	ax, 8008h ; Mute
  1435                                    	;mov	dx, [NAMBAR]
  1436                                  	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
  1437                                  	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
  1438                                    	;out	dx, ax
  1439                                  	;
  1440                                          ;call	delay1_4ms
  1441                                          ;call	delay1_4ms
  1442                                          ;call	delay1_4ms
  1443                                  	;call	delay1_4ms
  1444                                  
  1445                                  	;mov	ax, 0808h
  1446                                  	;mov	dx, [NAMBAR]
  1447                                  	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
  1448                                  	;out	dx, ax
  1449                                  	;
  1450                                          ;call	delay1_4ms
  1451                                          ;call	delay1_4ms
  1452                                          ;call	delay1_4ms
  1453                                  	;call	delay1_4ms
  1454                                  
  1455                                    	;mov	dx, [NAMBAR]
  1456                                          ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
  1457                                    	;out	dx, ax
  1458                                  	;
  1459                                    	;mov	dx, [NAMBAR]
  1460                                          ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
  1461                                    	;out	dx, ax
  1462                                  	;
  1463                                          ;call	delay1_4ms
  1464                                          ;call	delay1_4ms
  1465                                          ;call	delay1_4ms
  1466                                  	;call	delay1_4ms
  1467                                  
  1468                                  ;detect_ac97_codec:
  1469 00000335 C3                              retn
  1470                                  
  1471                                  reset_ac97_controller:
  1472                                  	; 11/11/2023
  1473                                  	; 10/06/2017
  1474                                  	; 29/05/2017
  1475                                  	; 28/05/2017
  1476                                  	; reset AC97 audio controller registers
  1477 00000336 31C0                    	xor     ax, ax
  1478 00000338 BA0B00                          mov	dx, PI_CR_REG
  1479 0000033B 0316[860F]              	add	dx, [NABMBAR]
  1480 0000033F EE                      	out     dx, al
  1481                                  
  1482 00000340 BA1B00                          mov     dx, PO_CR_REG
  1483 00000343 0316[860F]              	add	dx, [NABMBAR]
  1484 00000347 EE                      	out     dx, al
  1485                                  
  1486 00000348 BA2B00                          mov     dx, MC_CR_REG
  1487 0000034B 0316[860F]              	add	dx, [NABMBAR]
  1488 0000034F EE                      	out     dx, al
  1489                                  
  1490 00000350 B002                            mov     al, RR
  1491 00000352 BA0B00                          mov     dx, PI_CR_REG
  1492 00000355 0316[860F]              	add	dx, [NABMBAR]
  1493 00000359 EE                      	out     dx, al
  1494                                  
  1495 0000035A BA1B00                          mov     dx, PO_CR_REG
  1496 0000035D 0316[860F]              	add	dx, [NABMBAR]
  1497 00000361 EE                      	out     dx, al
  1498                                  
  1499 00000362 BA2B00                          mov     dx, MC_CR_REG
  1500 00000365 0316[860F]              	add	dx, [NABMBAR]
  1501 00000369 EE                      	out     dx, al
  1502                                  
  1503 0000036A C3                      	retn
  1504                                  
  1505                                  reset_ac97_codec:
  1506                                  	; 11/11/2023
  1507                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1508 0000036B BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1509 0000036E 0316[860F]              	add	dx, [NABMBAR]
  1510 00000372 66ED                    	in	eax, dx
  1511                                  
  1512                                  	;test	eax, 2
  1513                                  	; 06/08/2022
  1514 00000374 A802                    	test	al, 2
  1515 00000376 7405                    	jz	short _r_ac97codec_cold	
  1516                                  
  1517 00000378 E80E00                  	call	warm_ac97codec_reset
  1518 0000037B 7306                    	jnc	short _r_ac97codec_ok
  1519                                  _r_ac97codec_cold:
  1520 0000037D E83400                          call    cold_ac97codec_reset
  1521 00000380 7301                            jnc     short _r_ac97codec_ok
  1522                                  	
  1523                                  	; 16/04/2017
  1524                                          ;xor	eax, eax	; timeout error
  1525                                         	;stc
  1526 00000382 C3                      	retn
  1527                                  
  1528                                  _r_ac97codec_ok:
  1529 00000383 6631C0                          xor     eax, eax
  1530                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  1531 00000386 FEC0                            inc	al
  1532 00000388 C3                      	retn
  1533                                  
  1534                                  warm_ac97codec_reset:
  1535                                  	; 11/11/2023
  1536                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1537                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1538 00000389 66B806000000            	mov	eax, 6
  1539 0000038F BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1540 00000392 0316[860F]              	add	dx, [NABMBAR]
  1541 00000396 66EF                    	out	dx, eax
  1542                                  
  1543 00000398 B90A00                  	mov	cx, 10	; total 1s
  1544                                  _warm_ac97c_rst_wait:
  1545 0000039B E84D00                  	call	delay_100ms
  1546                                  
  1547 0000039E BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1548 000003A1 0316[860F]              	add	dx, [NABMBAR]
  1549 000003A5 66ED                    	in	eax, dx
  1550                                  
  1551 000003A7 66A900030010            	test	eax, CTRL_ST_CREADY
  1552 000003AD 7504                    	jnz	short _warm_ac97c_rst_ok
  1553                                  
  1554 000003AF 49                              dec     cx
  1555 000003B0 75E9                            jnz     short _warm_ac97c_rst_wait
  1556                                  
  1557                                  _warm_ac97c_rst_fail:
  1558 000003B2 F9                              stc
  1559                                  _warm_ac97c_rst_ok:
  1560 000003B3 C3                      	retn
  1561                                  
  1562                                  cold_ac97codec_reset:
  1563                                  	; 11/11/2023
  1564                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1565                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1566 000003B4 66B802000000                    mov	eax, 2
  1567 000003BA BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1568 000003BD 0316[860F]              	add	dx, [NABMBAR]
  1569 000003C1 66EF                    	out	dx, eax
  1570                                  
  1571 000003C3 E82500                  	call	delay_100ms 	; wait 100 ms
  1572 000003C6 E82200                  	call	delay_100ms 	; wait 100 ms
  1573 000003C9 E81F00                  	call	delay_100ms 	; wait 100 ms
  1574 000003CC E81C00                  	call	delay_100ms 	; wait 100 ms
  1575                                  
  1576 000003CF B91000                  	mov	cx, 16	; total 20*100 ms = 2s
  1577                                  
  1578                                  _cold_ac97c_rst_wait:
  1579 000003D2 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1580 000003D5 0316[860F]              	add	dx, [NABMBAR]
  1581 000003D9 66ED                    	in	eax, dx
  1582                                  
  1583 000003DB 66A900030010            	test	eax, CTRL_ST_CREADY
  1584 000003E1 7507                    	jnz	short _cold_ac97c_rst_ok
  1585                                  
  1586 000003E3 E80500                  	call	delay_100ms
  1587                                  
  1588 000003E6 49                              dec     cx
  1589 000003E7 75E9                            jnz     short _cold_ac97c_rst_wait
  1590                                  
  1591                                  _cold_ac97c_rst_fail:
  1592 000003E9 F9                              stc
  1593                                  _cold_ac97c_rst_ok:
  1594 000003EA C3                      	retn
  1595                                  
  1596                                  delay_100ms:
  1597                                  	; 11/11/2023
  1598                                  	; 29/05/2017
  1599                                  	; 24/03/2017 ('codec.asm')
  1600                                  	; wait 100 ms
  1601 000003EB 51                      	push	cx
  1602 000003EC B99001                  	mov	cx, 400  ; 400*0.25ms
  1603                                  _delay_x_ms:
  1604 000003EF E8A307                  	call	delay1_4ms
  1605 000003F2 E2FB                            loop	_delay_x_ms
  1606 000003F4 59                      	pop	cx
  1607 000003F5 C3                      	retn
  1608                                  
  1609                                  %endif
  1610                                  
  1611                                  ;=============================================================================
  1612                                  ;               ICH_WAV.ASM
  1613                                  ;=============================================================================
  1614                                  
  1615                                  ; DOS based .WAV player using AC'97 and codec interface.
  1616                                  ; ---------------------------------------------------------------
  1617                                  ; NASM version: Erdogan Tan (29/11/2016)
  1618                                  ; Last Update: 17/02/2017 (by Erdogan Tan)
  1619                                  
  1620                                  ; ICHWAV.ASM
  1621                                  ; PLAYMOD.ASM
  1622                                  ; player internal variables and other equates.
  1623                                  ;BUFFERSIZE	equ	2048*4		; 8K half buffer size. 18/02/2017
  1624                                  ; 14/05/2024
  1625                                  BUFFERSIZE	equ	2560*4		
  1626                                  ENDOFFILE	equ	BIT0		; flag for knowing end of file
  1627                                  
  1628                                  ;===========================================================================
  1629                                  ; entry: none.  File is already open and [filehandle] filled.
  1630                                  ; exit:  not until the song is finished or the user aborts.
  1631                                  ;
  1632                                  ; 18/02/2017
  1633                                  ModPlay: ; 13/02/2017  ; ModPlay Polling!
  1634                                  	;cld
  1635                                  	; clear (half) buffer 2
  1636                                         	;mov	di, [DMA_BUFFER2]
  1637                                  	;sub	ax, ax
  1638                                  	;mov	cx, (BUFFERSIZE/2)
  1639                                  	;rep	stosw
  1640                                  	
  1641                                         ; load 2048 bytes into buffer 1
  1642 000003F6 8B36[940F]              	mov	si, [DMA_BUFFER1]
  1643                                  	; 11/05/2024
  1644                                  	;mov	cx, BUFFERSIZE
  1645                                  	;push	ds ; segment
  1646                                  	;push	si ; offset
  1647                                  	;push	cx ; count
  1648 000003FA E89506                  	call    GetSamples_ICH ; 18/02/2017
  1649                                  
  1650                                         ; load 2048 bytes into buffer  2
  1651 000003FD 8B36[960F]              	mov	si, [DMA_BUFFER2]
  1652                                  	; 11/05/2024
  1653                                  	;mov	cx, BUFFERSIZE
  1654                                  	;push	ds ; segment
  1655                                  	;push	si ; offset
  1656                                  	;push	cx ; count
  1657 00000401 E88E06                  	call	GetSamples_ICH ; 18/02/2017
  1658                                  
  1659                                  ; register reset the DMA engine. This may cause a pop noise on the output
  1660                                  ; lines when the device is reset. Prolly a better idea to mute output, then
  1661                                  ; reset.
  1662                                  
  1663                                  	; 08/05/2024
  1664                                          ;mov    dx, [NABMBAR]
  1665                                          ;add    dx, PO_CR_REG		; set pointer to Ctrl reg
  1666                                          ;mov    al, RR			; set reset
  1667                                  	;out    dx, al			; self clearing bit
  1668                                  
  1669                                  ; write last valid index to 31 to start with.
  1670                                  ; The Last Valid Index register tells the DMA engine when to stop playing.
  1671                                  ; 
  1672                                  ; As we progress through the song we change the last valid index to always be
  1673                                  ; something other than the index we're currently playing.  
  1674                                  ;
  1675                                          ;;mov   al, 1
  1676                                          ;mov	al, 31
  1677                                  	;call   setLastValidIndex
  1678                                  
  1679                                  ; create Buffer Descriptor List
  1680                                  ;
  1681                                  ; A buffer descriptor list is a list of pointers and control bits that the
  1682                                  ; DMA engine uses to know where to get the .wav data and how to play it.
  1683                                  ;
  1684                                  ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
  1685                                  ; playing, I refresh the other one with good data.
  1686                                  ;
  1687                                  ;
  1688                                  ; For the control bits, you can specify that the DMA engine fire an interrupt
  1689                                  ; after a buffer has been processed, but I poll the current index register
  1690                                  ; to know when it's safe to update the other buffer.
  1691                                  ;
  1692                                  ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
  1693                                  ; if it ever runs out of data to play. Good for safety.
  1694                                  ;
  1695                                  	; 14/02/2017
  1696 00000404 8B3E[920F]                      mov     di, [BDL_BUFFER]		; get BDL address
  1697 00000408 B91000                          mov     cx, 32 / 2                      ; make 32 entries in BDL
  1698 0000040B 6631D2                  	xor	edx, edx
  1699 0000040E 8CDA                    	mov	dx, ds
  1700 00000410 66C1E204                	shl	edx, 4 ; segment*16 (linear/physical address of the segment)
  1701                                  _0:
  1702                                  
  1703                                  ; set buffer descriptor 0 to start of data file in memory
  1704                                  	; 14/02/2017
  1705 00000414 660FB706[940F]                  movzx   eax, word [DMA_BUFFER1]
  1706 0000041A 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1707 0000041D 66AB                            stosd					; store dmabuffer1 address
  1708                                  
  1709                                  ;
  1710                                  ; set length to 32k samples. 1 sample is 16bits or 2bytes.
  1711                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
  1712                                  ; 
  1713                                  
  1714                                  ; 17/02/2017 (Erdogan Tan)
  1715                                  ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC 97
  1716                                  ; Programmers Reference Manual
  1717                                  
  1718                                  ; 2.2.1 Buffer Descriptor List  (on Page 13)
  1719                                  	;
  1720                                  	;  Generic Form of Buffer Descriptor
  1721                                  	;  ---------------------------------
  1722                                  	;  63   62    61-48    47-32   31-0
  1723                                  	;  ---  ---  --------  ------- -----
  1724                                  	;  IOC  BUP -reserved- Buffer  Buffer
  1725                                  	;		      Length   Pointer
  1726                                  	;		      [15:0]   [31:0]
  1727                                  	;
  1728                                  	;  IOC:	Interrupt On Completion. 
  1729                                  	;	1 = Enabled. 
  1730                                  	;	    When this is set, it means that the controller should
  1731                                  	;	    issue an interrupt upon completion of this buffer.
  1732                                  	;	    It should also set the IOC bit in the status register
  1733                                  	;	0 = Disabled	
  1734                                  	;
  1735                                  	;  BUP: Buffer Underrun Policy.
  1736                                  	;       0 = When this buffer is complete,
  1737                                  	;	    if the next buffer is not yet ready 
  1738                                  	;	    (i.e., the last valid buffer has been processed),
  1739                                  	;	    then continue to transmit the last valid sample.
  1740                                  	;	1 = When this buffer is complete,
  1741                                  	;     	    if this is the last valid buffer, transmit zeros after
  1742                                  	;	    this buffer has been processed completely.
  1743                                  	;	    This bit typically is set only if this is the last 
  1744                                  	;	    buffer in the current stream.
  1745                                  	;
  1746                                  	; [31:0]: Buffer pointer. This field points to the location of
  1747                                  	;	  the data buffer. Since samples can be as wide as one
  1748                                  	;	  word, the buffer must be aligned with word boundaries,
  1749                                  	;	  to prevent samples from straddling DWord boundaries.
  1750                                  	;
  1751                                  	; [15:0]: Buffer Length: This is the length of the data buffer,
  1752                                  	;	  in number of samples. The controller uses this data
  1753                                  	;	  to determine the length of the buffer, in bytes.
  1754                                  	;	  "0" indicates no sample to process.
  1755                                  
  1756                                  ; ICH2AC97.INC
  1757                                  
  1758                                  ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
  1759                                  				; buffer is complete.
  1760                                  
  1761                                  ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
  1762                                  				; if this buffer is the last buffer
  1763                                  				; in a playback, fill the remaining
  1764                                  				; samples with 0 (silence) or not.
  1765                                  				; It's a good idea to set this to 1
  1766                                  				; for the last buffer in playback,
  1767                                  				; otherwise you're likely to get a lot
  1768                                  				; of noise at the end of the sound.
  1769                                  ;
  1770                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1771                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1772                                  ; Luckily for us, that's the same format as .wav files.
  1773                                  ;
  1774                                  ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
  1775                                  ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1776                                  ;
  1777                                  ; A value of 0 in these bits means play no samples.
  1778                                  ;
  1779                                  	; 08/12/2016 - Erdogan Tan
  1780                                  	;mov	eax, BUFFERSIZE
  1781                                  	;or	eax, IOC + BUP
  1782                                  	; 12/05/2024
  1783 0000041F 66B800140000            	mov	eax, BUFFERSIZE/2
  1784 00000425 660D00000040            	or	eax, BUP ; (tuneloop without interrupt)
  1785 0000042B 66AB                    	stosd
  1786                                  
  1787                                  ; 2nd buffer:
  1788                                  	; 14/02/2017
  1789 0000042D 660FB706[960F]                  movzx   eax, word [DMA_BUFFER2]
  1790 00000433 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1791 00000436 66AB                            stosd					; store dmabuffer2 address
  1792                                  
  1793                                  ; set length to 64k (32k of two 16 bit samples)
  1794                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
  1795                                  ; 
  1796                                  	; 08/12/2016 - Erdogan Tan
  1797                                  	;mov	eax, BUFFERSIZE
  1798                                  	;or	eax, IOC + BUP
  1799                                  	; 12/05/2024
  1800 00000438 66B800140000            	mov	eax, BUFFERSIZE/2
  1801 0000043E 660D00000040            	or	eax, BUP ; (tuneloop without interrupt)
  1802 00000444 66AB                    	stosd
  1803 00000446 E2CC                            loop    _0
  1804                                  
  1805                                  ;
  1806                                  ; tell the DMA engine where to find our list of Buffer Descriptors.
  1807                                  ; this 32bit value is a flat mode memory offset (ie no segment:offset)
  1808                                  ;
  1809                                  ; write NABMBAR+10h with offset of buffer descriptor list
  1810                                  ;
  1811 00000448 660FB706[920F]                  movzx   eax, word [BDL_BUFFER]
  1812                                  	; 14/02/2017
  1813 0000044E 6601D0                  	add	eax, edx ; linear/physical address of the BDL
  1814                                    	; 18/02/2017
  1815 00000451 8B16[860F]                      mov     dx, [NABMBAR]
  1816 00000455 83C210                          add     dx, PO_BDBAR_REG                ; set pointer to BDL
  1817 00000458 66EF                            out     dx, eax                         ; write to AC97 controller
  1818                                  
  1819                                  ;
  1820                                  ; All set.  Let's play some music.
  1821                                  ;
  1822                                  	; 08/12/2016
  1823                                  	; 07/10/2016
  1824                                          ;mov    al, 1
  1825 0000045A B01F                            mov	al, 31
  1826                                  	; 08/05/2024
  1827 0000045C A2[A20F]                	mov	[LVI], al ; 10/11/2023
  1828                                  	
  1829 0000045F E8C200                  	call    setLastValidIndex
  1830                                  
  1831 00000462 C606[8B0F]01            	mov	byte [tLoop], 1 ; 30/11/2016
  1832                                  
  1833                                  ; 12/05/2024 (tuneloop, without interrupt)
  1834                                  %if 0
  1835                                  	; 12/05/2024	
  1836                                  	; 17/02/2017
  1837                                          ;mov    dx, [NABMBAR]
  1838                                          ;add    dx, PO_CR_REG                   ; PCM out Control Register
  1839                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  1840                                  	;			; (LVBI interrupt will not be enabled)
  1841                                          ;out    dx, al                          ; Start bus master operation.
  1842                                  
  1843                                  ; while DMA engine is running, examine current index and wait until it hits 1
  1844                                  ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
  1845                                  ; 64k.  Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
  1846                                     
  1847                                  	; 18/02/2017
  1848                                  	; 14/02/2017
  1849                                  	; 13/02/2017
  1850                                  	; 08/12/2016
  1851                                  	; 28/11/2016
  1852                                  
  1853                                  	push	es
  1854                                  	mov	ax, 0A000h
  1855                                  	mov	es, ax
  1856                                  	;mov	bp, DmaBuffer ; 14/02/2017
  1857                                  p_loop:
  1858                                  	mov     ah, 1			; any key pressed?
  1859                                  	int     16h			; no, Loop.
  1860                                  	jz	short q_loop
  1861                                  
  1862                                  	mov     ah, 0			; flush key buffer...
  1863                                  	int     16h
  1864                                  p_return:
  1865                                  	mov	byte [tLoop], 0	; 13/02/2017
  1866                                  	pop	es
  1867                                  	retn
  1868                                  q_loop:
  1869                                  	; 10/05/2024
  1870                                  	xor	ax, ax
  1871                                  	xchg	al, [tBuff] ; AL = [tBuff], [tBuff] = 0
  1872                                  	cmp	al, 1
  1873                                  	ja	short r_loop
  1874                                  	jb	short ScopeLoop
  1875                                  	;
  1876                                       	mov	si, [DMA_BUFFER1] ; [tBuff]=1 (from tuneLoop)
  1877                                         	jmp	short s_loop 
  1878                                  r_loop:
  1879                                  	; 13/02/2017
  1880                                          mov     si, [DMA_BUFFER2] ; [tBuff]=2 (from tuneLoop)
  1881                                  s_loop:
  1882                                  	; 14/02/2017
  1883                                  	;mov	bp, si ; save current buffer addres in bp register
  1884                                  	; 11/05/2024
  1885                                  	;mov	cx, BUFFERSIZE ; 2048*4 byte
  1886                                  	;push	ds ; segment
  1887                                  	;push	si ; offset
  1888                                  	;push	cx ; count
  1889                                  	call    GetSamples_ICH ; 18/02/2017
  1890                                  	;
  1891                                  ScopeLoop:
  1892                                  	;mov    si, bp			; get current samples
  1893                                  	mov	si, MOD_BUFFER ; 18/02/2017
  1894                                  	xor     cx, cx			; to be drawed ...
  1895                                  	xor     dx, dx
  1896                                  DrawLoop:       
  1897                                  	mov     bx, dx			; (save Index)
  1898                                  	mov     di, [Scope+bx]		; get old SCOPE pixel address
  1899                                  	mov     byte [es:di], 0		; erase it!
  1900                                  	;lodsb				; get a sample (8-bit)
  1901                                  	; 14/05/2024
  1902                                  	lodsw
  1903                                  	mov     bl, al			; calc new pixel address...
  1904                                  	xor     bh, bh
  1905                                  	shl     bx, 1
  1906                                  	mov     di, [RowOfs+bx]
  1907                                  	add     di, cx
  1908                                  	mov     bx, dx			; (restore Index)
  1909                                  	mov     [Scope+bx], di		; save new address...
  1910                                  	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  1911                                  	add     dx, 2			; the next pixel...
  1912                                  	inc     cx
  1913                                  	cmp     cx, 320			; 320 pixels drawed?
  1914                                  	jb      short DrawLoop
  1915                                  	jmp	short p_loop
  1916                                  
  1917                                  tuneLoop:
  1918                                  	; 11/05/2024
  1919                                  	; 11/11/2023
  1920                                  	; 10/11/2023
  1921                                  	; 18/02/2017
  1922                                  	; 08/12/2016
  1923                                  	; 28/11/2016 - Erdogan Tan
  1924                                  
  1925                                  	; 11/05/2024
  1926                                  	cmp	byte [tLoop], 1
  1927                                  	jb	short tL3
  1928                                  	
  1929                                  	call    getCurrentIndex
  1930                                  
  1931                                  	; 10/11/2023
  1932                                  	cmp	al, [LVI]
  1933                                  	jne	short tL1
  1934                                  
  1935                                  	dec	ax
  1936                                  	and	al, 1Fh 
  1937                                  	call	setLastValidIndex
  1938                                  	xchg	al, [LVI]
  1939                                  tL1:
  1940                                  	test	al, BIT0
  1941                                  	jz	short tL2
  1942                                  
  1943                                  	; 11/05/2024
  1944                                  	mov	byte [tBuff], 1
  1945                                  	retn
  1946                                  tL2:	
  1947                                  	mov	byte [tBuff], 2
  1948                                  tL3:
  1949                                  	retn
  1950                                  
  1951                                  ; returns AL = current index value
  1952                                  getCurrentIndex:
  1953                                  	;push	dx
  1954                                  	mov	dx, [NABMBAR]
  1955                                  	add	dx, PO_CIV_REG
  1956                                  	in	al, dx
  1957                                  	;pop	dx
  1958                                  	retn
  1959                                  
  1960                                  ;input AL = index # to stop on
  1961                                  setLastValidIndex:
  1962                                  	;push	dx
  1963                                  	mov	dx, [NABMBAR]
  1964                                  	add	dx, PO_LVI_REG
  1965                                          out     dx, al
  1966                                  	;pop	dx
  1967                                  	retn
  1968                                  
  1969                                  %else
  1970                                  	; 12/05/2024
  1971                                  	; 17/02/2017
  1972 00000467 8B16[860F]                      mov     dx, [NABMBAR]
  1973 0000046B 83C21B                          add     dx, PO_CR_REG		; PCM out Control Register
  1974                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  1975                                  	;			; (LVBI interrupt will not be enabled)
  1976                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
  1977 0000046E B001                    	mov	al, RPBM
  1978 00000470 EE                      	out     dx, al			; Start bus master operation.
  1979                                  
  1980 00000471 06                      	push	es
  1981 00000472 B800A0                  	mov	ax, 0A000h
  1982 00000475 8EC0                    	mov	es, ax
  1983                                  
  1984                                  	; 12/05/2024
  1985                                  ;p_loop:
  1986                                  ;	call	tuneLoop
  1987                                  ;	cmp	byte [tLoop], 0
  1988                                  ;	ja	short p_loop
  1989                                  ;	pop	es
  1990                                  ;	retn
  1991                                  
  1992                                  p_loop:
  1993 00000477 B401                    	mov     ah, 1			; any key pressed?
  1994                                  	;mov	ah, 11h
  1995 00000479 CD16                    	int     16h			; no, Loop.
  1996 0000047B 743D                    	jz	short q_loop
  1997                                  
  1998 0000047D B400                    	mov	ah, 0
  1999                                  	;mov    ah, 10h			; flush key buffer...
  2000 0000047F CD16                    	int     16h
  2001                                  
  2002                                  	; 12/05/2024 (change PCM out volume)
  2003 00000481 3C2B                    	cmp	al, '+'
  2004 00000483 750B                    	jne	short p_1
  2005                                  	
  2006 00000485 A0[A30F]                	mov	al, [volume]
  2007 00000488 3C00                    	cmp	al, 0
  2008 0000048A 762E                    	jna	short q_loop
  2009 0000048C FEC8                    	dec	al
  2010 0000048E EB0D                    	jmp	short p_2
  2011                                  p_1:
  2012 00000490 3C2D                    	cmp	al, '-'
  2013 00000492 7524                    	jne	short p_return
  2014                                  
  2015 00000494 A0[A30F]                	mov	al, [volume]
  2016 00000497 3C1F                    	cmp	al, 31
  2017 00000499 731F                    	jnb	short q_loop	
  2018 0000049B FEC0                    	inc	al
  2019                                  p_2:
  2020 0000049D A2[A30F]                	mov	[volume], al
  2021 000004A0 88C4                    	mov	ah, al
  2022 000004A2 8B16[840F]              	mov     dx, [NAMBAR]
  2023                                    	;add    dx, CODEC_MASTER_VOL_REG
  2024 000004A6 83C218                  	add	dx, CODEC_PCM_OUT_REG
  2025 000004A9 EF                      	out     dx, ax
  2026                                  
  2027                                  	; 12/05/2024
  2028 000004AA E8E806                  	call    delay1_4ms
  2029 000004AD E8E506                          call    delay1_4ms
  2030 000004B0 E8E206                          call    delay1_4ms
  2031 000004B3 E8DF06                          call    delay1_4ms
  2032                                  
  2033 000004B6 EB02                    	jmp	short q_loop
  2034                                  
  2035                                  p_return:
  2036 000004B8 07                      	pop	es
  2037 000004B9 C3                      	retn
  2038                                  q_loop:
  2039                                  tuneLoop:
  2040                                  	; 12/05/2024
  2041                                  	; 18/11/2023 (ich_wav4.asm, Erdogan Tan)
  2042                                  tL1:
  2043 000004BA E85400                  	call    updateLVI	; /set LVI != CIV/
  2044                                  	;call   check4keyboardstop
  2045                                  	;jc	short _exit_
  2046                                  	;call   getCurrentIndex
  2047 000004BD A801                    	test	al, BIT0
  2048 000004BF 74F9                    	jz	short tL1	; loop if buffer 2 is not playing
  2049                                  
  2050 000004C1 8B36[940F]              	mov     si, [DMA_BUFFER1]
  2051 000004C5 E8CA05                  	call    GetSamples_ICH
  2052                                  
  2053 000004C8 E81300                  	call	ScopeLoop
  2054                                  tL2:
  2055 000004CB E84300                  	call    updateLVI
  2056                                  	;call   check4keyboardstop
  2057                                  	;jc	short _exit_
  2058                                  	;call   getCurrentIndex
  2059 000004CE A801                    	test	al, BIT0
  2060 000004D0 75F9                    	jnz	short tL2	; loop if buffer 1 is not playing
  2061                                  
  2062 000004D2 8B36[960F]              	mov     si, [DMA_BUFFER2]
  2063 000004D6 E8B905                  	call    GetSamples_ICH
  2064                                  
  2065 000004D9 E80200                  	call	ScopeLoop
  2066 000004DC EB99                    	jmp	short p_loop
  2067                                  
  2068                                  ScopeLoop:
  2069                                  	;mov    si, bp			; get current samples
  2070 000004DE BE[B2C3]                	mov	si, MOD_BUFFER ; 18/02/2017
  2071 000004E1 31C9                    	xor     cx, cx			; to be drawed ...
  2072 000004E3 31D2                    	xor     dx, dx
  2073                                  DrawLoop:       
  2074 000004E5 89D3                    	mov     bx, dx			; (save Index)
  2075 000004E7 8BBF[30BF]              	mov     di, [Scope+bx]		; get old SCOPE pixel address
  2076 000004EB 26C60500                	mov     byte [es:di], 0		; erase it!
  2077                                  	;lodsb				; get a sample (8-bit)
  2078                                  	; 12/05/2024
  2079 000004EF AD                      	lodsw
  2080 000004F0 88C3                    	mov     bl, al			; calc new pixel address...
  2081 000004F2 30FF                    	xor     bh, bh
  2082 000004F4 D1E3                    	shl     bx, 1
  2083 000004F6 8BBF[B0C1]              	mov     di, [RowOfs+bx]
  2084 000004FA 01CF                    	add     di, cx
  2085 000004FC 89D3                    	mov     bx, dx			; (restore Index)
  2086 000004FE 89BF[30BF]              	mov     [Scope+bx], di		; save new address...
  2087 00000502 26C6050A                	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  2088 00000506 83C202                  	add     dx, 2			; the next pixel...
  2089 00000509 41                      	inc     cx
  2090 0000050A 81F94001                	cmp     cx, 320			; 320 pixels drawed?
  2091 0000050E 72D5                    	jb      short DrawLoop
  2092 00000510 C3                      	retn
  2093                                  	
  2094                                  ;_exit_:
  2095                                  	;mov	byte [tLoop], 0
  2096                                  	;retn
  2097                                  
  2098                                  	; 12/05/2024
  2099                                  updateLVI:
  2100                                  	; 06/11/2023
  2101 00000511 8B16[860F]              	mov	dx, [NABMBAR]      		
  2102 00000515 83C214                  	add	dx, PO_CIV_REG
  2103                                  	; (Current Index Value and Last Valid Index value)
  2104 00000518 ED                      	in	ax, dx
  2105                                  
  2106 00000519 38E0                    	cmp	al, ah ; is current index = last index ?
  2107 0000051B 750F                    	jne	short uLVI_exit ; 12/05/2024
  2108                                  
  2109                                  	; 08/11/2023	
  2110 0000051D E80D00                  	call	getCurrentIndex
  2111                                  
  2112 00000520 FEC8                    	dec	al
  2113 00000522 241F                    	and	al, 1Fh
  2114                                  
  2115                                  ;input AL = index # to stop on
  2116                                  setLastValidIndex:
  2117                                  	; 08/11/2023
  2118                                  	;push	dx
  2119 00000524 8B16[860F]              	mov	dx, [NABMBAR]
  2120 00000528 83C215                  	add	dx, PO_LVI_REG
  2121 0000052B EE                              out     dx, al
  2122                                  	;pop	dx
  2123                                  uLVI_exit:	; 12/05/2024
  2124 0000052C C3                      	retn
  2125                                  
  2126                                  ; returns AL = current index value
  2127                                  getCurrentIndex:
  2128                                  	;push	dx
  2129 0000052D 8B16[860F]              	mov	dx, [NABMBAR]
  2130 00000531 83C214                  	add	dx, PO_CIV_REG
  2131 00000534 EC                      	in	al, dx
  2132                                  	;pop	dx
  2133 00000535 C3                      	retn
  2134                                  
  2135                                  	; 12/05/2024
  2136                                  check4keyboardstop:
  2137                                  	; 08/11/2023
  2138                                  	; 04/11/2023
  2139 00000536 B401                    	mov	ah, 1
  2140 00000538 CD16                    	int	16h
  2141 0000053A 7405                    	jz	short _cksr
  2142 0000053C 30E4                    	xor	ah, ah
  2143 0000053E CD16                    	int	16h
  2144 00000540 F9                      	stc
  2145                                  _cksr:
  2146 00000541 C3                      	retn
  2147                                  
  2148                                  %endif
  2149                                  
  2150                                  ;=============================================================================
  2151                                  ;               MODLOAD.ASM
  2152                                  ;=============================================================================
  2153                                  
  2154                                  ; Amiga Module Loader v0.1b by Carlos Hasan.
  2155                                  ;		July 10th, 1993.
  2156                                  
  2157                                  ; STRUCTURES
  2158                                  
  2159                                  struc ModSample
  2160 00000000 <res 16h>               .msName:	resb 22
  2161 00000016 ????                    .msLength:	resw 1
  2162 00000018 ??                      .msFinetune:	resb 1
  2163 00000019 ??                      .msVolume:	resb 1
  2164 0000001A ????                    .msRepeat:	resw 1
  2165 0000001C ????                    .msRepLen:	resw 1
  2166                                  .size:
  2167                                  endstruc
  2168                                  
  2169                                  struc ModHeader
  2170 00000000 <res 14h>               .mhName:	resb 20
  2171 00000014 <res 3A2h>              .mhSamples:	resb ModSample.size*31
  2172 000003B6 ??                      .mhOrderLen:	resb 1
  2173 000003B7 ??                      .mhReStart:	resb 1
  2174 000003B8 <res 80h>               .mhOrder:	resb 128
  2175 00000438 ????????                .mhSign:	resw 2
  2176                                  .size:	
  2177                                  endstruc
  2178                                  
  2179                                  struc ModInfoRec
  2180 00000000 ??                      .OrderLen:	resb 1
  2181 00000001 ??                      .ReStart:	resb 1
  2182 00000002 <res 80h>               .Order:		resb 128
  2183 00000082 ????????                .Patterns:	resd 1
  2184 00000086 <res 3Eh>               .SampOfs:	resw 31
  2185 000000C4 <res 3Eh>               .SampSeg:	resw 31
  2186 00000102 <res 3Eh>               .SampLen:	resw 31
  2187 00000140 <res 3Eh>               .SampRep:	resw 31
  2188 0000017E <res 3Eh>               .SampRepLen:	resw 31
  2189 000001BC <res 3Eh>               .SampVol:	resw 31
  2190                                  .size:	
  2191                                  endstruc
  2192                                  
  2193                                  ; CODE
  2194                                  
  2195                                  LoadModule:
  2196                                  		;es:di = filename
  2197                                  
  2198                                  		;[sp+4] = es
  2199                                  		;[sp+2] = di
  2200                                  
  2201                                  		FileName equ 4		
  2202                                  
  2203 00000542 55                      		push    bp
  2204 00000543 89E5                    		mov     bp, sp
  2205 00000545 60                      		pusha
  2206 00000546 1E                      		push    ds
  2207 00000547 06                      		push    es
  2208                                  
  2209 00000548 C706[A660]0100          		mov	word [ErrorInfo], 1
  2210                                  
  2211 0000054E E85101                  		call    ClearModInfo
  2212                                  OpenFile:       
  2213 00000551 1E                      		push    ds
  2214 00000552 B8003D                  		mov     ax, 3D00h
  2215 00000555 C55604                  		lds     dx, [bp+FileName]
  2216 00000558 CD21                    		int     21h
  2217 0000055A 1F                      		pop     ds
  2218 0000055B 0F823C01                		jc      Failed
  2219 0000055F A3[A460]                		mov     [FileHandle], ax
  2220                                  
  2221                                  ReadHeader:     
  2222 00000562 B8003F                  		mov     ax, 3F00h
  2223 00000565 8B1E[A460]              		mov     bx, [FileHandle]
  2224 00000569 B93C04                  		mov     cx, ModHeader.size
  2225                                  		;lea    dx, [Header]
  2226 0000056C BA[A860]                		mov	dx, Header
  2227 0000056F CD21                    		int     21h
  2228 00000571 0F821D01                		jc      CloseFile
  2229                                  CheckMK:        
  2230 00000575 813E[E064]4D2E          		cmp     word [Header+ModHeader.mhSign], 'M.'
  2231 0000057B 7508                    		jne     short CheckFLT4
  2232 0000057D 813E[E264]4B2E          		cmp     word [Header+ModHeader.mhSign+2], 'K.'
  2233 00000583 7439                    		je      short IsModFile
  2234                                  CheckFLT4:
  2235 00000585 813E[E064]464C          		cmp     word [Header+ModHeader.mhSign], 'FL'
  2236 0000058B 7508                    		jne     short Is15Inst
  2237 0000058D 813E[E264]5434          		cmp     word [Header+ModHeader.mhSign+2], 'T4'
  2238 00000593 7429                    		je      short IsModFile
  2239                                  Is15Inst:
  2240 00000595 BE[7E62]                		mov     si, (Header+ModHeader.mhSamples) + (15*ModSample.size)
  2241 00000598 BF[5E64]                		mov     di, Header+ModHeader.mhOrderLen
  2242 0000059B 8CD8                    		mov     ax, ds
  2243 0000059D 8EC0                    		mov     es, ax
  2244 0000059F FC                      		cld
  2245 000005A0 B98200                  		mov     cx, 130
  2246 000005A3 F3A4                    		rep     movsb
  2247 000005A5 BF[7E62]                		mov     di, Header+ModHeader.mhSamples + (15*ModSample.size)
  2248 000005A8 31C0                    		xor     ax, ax
  2249 000005AA B9E001                  		mov     cx, 16*ModSample.size
  2250 000005AD F3AA                    		rep     stosb
  2251                                  SeekPatterns:   
  2252 000005AF B80042                  		mov     ax, 4200h
  2253 000005B2 8B1E[A460]              		mov     bx, [FileHandle]
  2254 000005B6 B90000                  		mov     cx, 0
  2255 000005B9 BA5802                  		mov     dx, 600
  2256 000005BC CD21                    		int     21h
  2257                                  IsModFile:  
  2258 000005BE A0[5E64]                		mov     al, [Header+ModHeader.mhOrderLen]
  2259 000005C1 A2[E664]                		mov     [ModInfo.OrderLen], al
  2260                                  
  2261 000005C4 A0[5F64]                		mov     al, [Header+ModHeader.mhReStart]
  2262 000005C7 3A06[5E64]              		cmp     al, [Header+ModHeader.mhOrderLen]
  2263 000005CB 7202                    		jb      short SetReStart
  2264 000005CD B07F                    		mov     al, 7Fh
  2265                                  SetReStart:
  2266 000005CF A2[E764]                		mov     [ModInfo.ReStart], al
  2267                                  
  2268 000005D2 B98000                  		mov     cx, 128
  2269 000005D5 31C0                    		xor     ax, ax
  2270 000005D7 31DB                    		xor     bx, bx
  2271                                  CopyOrder:
  2272 000005D9 8AA7[6064]              		mov     ah, [Header+ModHeader.mhOrder+bx]
  2273 000005DD 88A7[E864]              		mov     [ModInfo.Order+bx], ah
  2274 000005E1 38C4                    		cmp     ah, al
  2275 000005E3 7202                    		jb      short NextOrder
  2276 000005E5 88E0                    		mov     al, ah
  2277                                  NextOrder:
  2278 000005E7 43                      		inc     bx
  2279 000005E8 E2EF                    		loop    CopyOrder
  2280                                  AllocPatterns:  
  2281                                  		; Erdogan Tan (13/02/2017)
  2282 000005EA 30E4                    		xor	ah, ah
  2283 000005EC FEC0                    		inc	al
  2284                                  		; al = count of 1024 bytes
  2285 000005EE 89C3                    		mov	bx, ax
  2286                                  		; count of paragraphs = al*64 
  2287 000005F0 C1E006                  		shl	ax, 6 ; *64
  2288 000005F3 89C5                    		mov	bp, ax
  2289 000005F5 8CCA                    		mov	dx, cs ; current (code) segment
  2290 000005F7 81C20010                		add	dx, 1000h ; next 64K (4096*16)
  2291                                  		;
  2292 000005FB C706[6865]0000          		mov	word [ModInfo.Patterns], 0
  2293 00000601 8916[6A65]              		mov	[ModInfo.Patterns+2], dx
  2294                                  		;
  2295 00000605 01D5                    		add	bp, dx ; next segment for samples
  2296                                  ReadPatterns:   
  2297 00000607 1E                      		push    ds
  2298 00000608 B8003F                  		mov     ax, 3F00h
  2299 0000060B 89D9                    		mov     cx, bx ; count of 1024 bytes
  2300 0000060D C1E10A                  		shl     cx, 10 ; byte count (cx*1024)
  2301 00000610 8B1E[A460]              		mov     bx, [FileHandle]
  2302                                  		;lds    dx, [ModInfo.Patterns]
  2303 00000614 8EDA                    		mov	ds, dx
  2304 00000616 31D2                    		xor	dx, dx
  2305 00000618 CD21                    		int     21h
  2306 0000061A 1F                      		pop     ds
  2307 0000061B 7275                    		jc      CloseFile
  2308                                  
  2309                                  		;lea	si, [Header+ModHeader.mhSamples]
  2310 0000061D BE[BC60]                		mov	si, Header+ModHeader.mhSamples
  2311 00000620 31FF                    		xor     di, di
  2312                                  CopySamples:
  2313 00000622 8B4416                  		mov     ax, [si+ModSample.msLength]
  2314 00000625 86C4                    		xchg    al, ah
  2315 00000627 D1E0                    		shl     ax, 1
  2316 00000629 8985[E865]              		mov     [ModInfo.SampLen+di], ax
  2317 0000062D 8A4419                  		mov     al, [si+ModSample.msVolume]
  2318 00000630 30E4                    		xor     ah, ah
  2319 00000632 8985[A266]              		mov     [ModInfo.SampVol+di], ax
  2320 00000636 8B441A                  		mov     ax, [si+ModSample.msRepeat]
  2321 00000639 86C4                    		xchg    al, ah
  2322 0000063B D1E0                    		shl     ax, 1
  2323 0000063D 8985[2666]              		mov     [ModInfo.SampRep+di], ax
  2324 00000641 8B441C                  		mov     ax, [si+ModSample.msRepLen]
  2325 00000644 86C4                    		xchg    al, ah
  2326 00000646 D1E0                    		shl     ax, 1
  2327 00000648 8985[6466]              		mov     [ModInfo.SampRepLen+di], ax
  2328 0000064C 83C61E                  		add     si, ModSample.size
  2329 0000064F 83C702                  		add     di, 2
  2330 00000652 83FF3E                  		cmp     di, 2*31
  2331 00000655 72CB                    		jb      short CopySamples
  2332                                  
  2333 00000657 31F6                    		xor     si, si
  2334                                  AllocSamples:
  2335                                  		; Erdogan Tan (13/02/2017)
  2336                                  		;mov	bx, [ModInfo.SampLen+si]
  2337 00000659 8B8C[E865]              		mov	cx, [ModInfo.SampLen+si]
  2338 0000065D 89CB                    		mov	bx, cx
  2339 0000065F C1EB04                  		shr     bx, 4 ; byte count / 16
  2340 00000662 7420                    		jz      short NextSample
  2341 00000664 43                      		inc	bx ; number of paragraphs
  2342 00000665 C784[6C65]0000          		mov	word [ModInfo.SampOfs+si], 0
  2343 0000066B 89AC[AA65]              		mov     [ModInfo.SampSeg+si], bp
  2344 0000066F 89EA                    		mov	dx, bp
  2345 00000671 01DD                    		add	bp, bx ; next segment for sample 
  2346                                  ReadSample:
  2347 00000673 1E                      		push    ds
  2348 00000674 B8003F                  		mov     ax, 3F00h
  2349 00000677 8B1E[A460]              		mov     bx, [FileHandle]
  2350                                  		;mov    cx, [ModInfo.SampLen+si]
  2351                                  		;mov    dx, [ModInfo.SampOfs+si]
  2352                                  		;mov    ds, [ModInfo.SampSeg+si]
  2353 0000067B 8EDA                    		mov	ds, dx
  2354 0000067D 31D2                    		xor	dx, dx	
  2355 0000067F CD21                    		int     21h
  2356 00000681 1F                      		pop     ds
  2357 00000682 720E                    		jc      short CloseFile
  2358                                  NextSample:
  2359 00000684 83C602                  		add     si, 2
  2360 00000687 83FE3E                  		cmp     si, 2*31
  2361 0000068A 72CD                    		jb      short AllocSamples
  2362                                  
  2363 0000068C C706[A660]0000          		mov     word [ErrorInfo], 0
  2364                                  CloseFile:      
  2365 00000692 B8003E                  		mov     ax, 3E00h
  2366 00000695 8B1E[A460]              		mov     bx, [FileHandle]
  2367 00000699 CD21                    		int     21h
  2368                                  Failed:         
  2369 0000069B 07                      		pop     es
  2370 0000069C 1F                      		pop     ds
  2371 0000069D 61                      		popa
  2372 0000069E 5D                      		pop     bp
  2373 0000069F C20400                  		ret	4
  2374                                  
  2375                                  FreeModule:
  2376                                  		; Erdogan Tan (13/02/2017)
  2377                                  		; nothing to do here for memory de-allocation
  2378                                  ClearModInfo:
  2379 000006A2 60                      		pusha
  2380 000006A3 06                      		push    es
  2381 000006A4 8CD8                    		mov     ax, ds
  2382 000006A6 8EC0                    		mov     es, ax
  2383                                  		;lea    di, [ModInfo]
  2384 000006A8 BF[E664]                		mov	di, ModInfo
  2385 000006AB B9FA01                  		mov     cx, ModInfoRec.size
  2386 000006AE FC                      		cld
  2387 000006AF 31C0                    		xor     ax, ax
  2388 000006B1 F3AA                    		rep     stosb
  2389 000006B3 07                      		pop     es
  2390 000006B4 61                      		popa
  2391 000006B5 C3                      		retn
  2392                                  
  2393                                  ;=============================================================================
  2394                                  ;               MODPLAY.ASM
  2395                                  ;=============================================================================
  2396                                  
  2397                                  ; Amiga Module Player v0.3b by Carlos Hasan.
  2398                                  ;		July 23th, 1993.
  2399                                  
  2400                                  ; EQUATES
  2401                                  
  2402                                  NumTracks       equ 4
  2403                                  DefTempo        equ 6
  2404                                  DefBpm          equ 125
  2405                                  MidCRate        equ 8448
  2406                                  MixBufSize      equ 4096
  2407                                  
  2408                                  ; STRUCTURES
  2409                                  
  2410                                  struc TrackInfo
  2411 00000000 ????????                .Samples:	resd 1
  2412 00000004 ????                    .Position:	resw 1
  2413 00000006 ????                    .Len:		resw 1
  2414 00000008 ????                    .Repeat:	resw 1
  2415 0000000A ????                    .RepLen:	resw 1
  2416 0000000C ??                      .Volume: 	resb 1
  2417 0000000D ??                      .Error:		resb 1
  2418 0000000E ????                    .Period:	resw 1
  2419 00000010 ????                    .Pitch:		resw 1
  2420 00000012 ????                    .Effect:	resw 1
  2421 00000014 ????                    .PortTo:	resw 1
  2422 00000016 ??                      .PortParm:	resb 1
  2423 00000017 ??                      .VibPos:	resb 1
  2424 00000018 ??                      .VibParm:	resb 1
  2425 00000019 ??                      .OldSampOfs:	resb 1
  2426 0000001A ????????????            .Arp:		resw 3
  2427 00000020 ????                    .ArpIndex:	resw 1
  2428                                  .size:
  2429                                  endstruc
  2430                                  
  2431                                  ; CODE
  2432                                  
  2433                                  ;--------------------------------------------------------------------------
  2434                                  ; BeatTrack:  Process the next beat in one track.
  2435                                  ;  In:
  2436                                  ;    ds:di -  Track info Address.
  2437                                  ;--------------------------------------------------------------------------
  2438                                  
  2439                                  BeatTrack:
  2440 000006B6 8B5512                  		mov     dx, [di+TrackInfo.Effect]
  2441 000006B9 85D2                    		test    dx, dx
  2442 000006BB 7430                    		je      short None
  2443 000006BD 80FE00                  		cmp     dh, 00h
  2444 000006C0 742C                    		je      short Arpeggio
  2445 000006C2 80FE01                  		cmp     dh, 01h
  2446 000006C5 743E                    		je      short PortUp
  2447 000006C7 80FE02                  		cmp     dh, 02h
  2448 000006CA 7455                    		je      short PortDown
  2449 000006CC 80FE03                  		cmp     dh, 03h
  2450 000006CF 746D                    		je      short TonePort
  2451 000006D1 80FE04                  		cmp     dh, 04h
  2452 000006D4 0F849100                		je      Vibrato
  2453 000006D8 80FE05                  		cmp     dh, 05h
  2454 000006DB 0F84D600                		je      PortSlide
  2455 000006DF 80FE06                  		cmp     dh, 06h
  2456 000006E2 0F84D700                		je      VibSlide
  2457 000006E6 80FE0A                  		cmp     dh, 0Ah
  2458 000006E9 0F84D800                		je      VolSlide
  2459                                  None:           
  2460 000006ED C3                      		retn
  2461                                  Arpeggio:
  2462 000006EE 8B5D20                  		mov     bx, [di+TrackInfo.ArpIndex]
  2463 000006F1 8B411A                  		mov     ax, [di+TrackInfo.Arp+bx]
  2464 000006F4 894510                  		mov     [di+TrackInfo.Pitch], ax
  2465 000006F7 83C302                  		add     bx, 2
  2466 000006FA 83FB06                  		cmp     bx, 6
  2467 000006FD 7202                    		jb      short SetArpIndex
  2468 000006FF 31DB                    		xor     bx,bx
  2469                                  SetArpIndex:
  2470 00000701 895D20                  		mov     [di+TrackInfo.ArpIndex], bx
  2471 00000704 C3                      		retn
  2472                                  PortUp:
  2473 00000705 30F6                    		xor     dh, dh
  2474 00000707 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2475 0000070A 29D3                    		sub     bx, dx
  2476 0000070C 83FB71                  		cmp     bx, 113
  2477 0000070F 7D03                    		jge     short NotSmall
  2478 00000711 BB7100                  		mov     bx, 113
  2479                                  NotSmall:
  2480 00000714 895D0E                  		mov     [di+TrackInfo.Period], bx
  2481 00000717 01DB                    		add     bx, bx
  2482 00000719 8B87[E066]              		mov     ax, [PitchTable+bx]
  2483 0000071D 894510                  		mov     [di+TrackInfo.Pitch], ax
  2484 00000720 C3                      		retn
  2485                                  PortDown:
  2486 00000721 30F6                    		xor     dh, dh
  2487 00000723 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2488 00000726 01D3                    		add     bx, dx
  2489 00000728 81FB5803                		cmp     bx, 856
  2490 0000072C 7E03                    		jle     short NotBig
  2491 0000072E BB5803                  		mov     bx, 856
  2492 00000731 895D0E                  NotBig:         mov     [di+TrackInfo.Period], bx
  2493 00000734 01DB                    		add     bx, bx
  2494 00000736 8B87[E066]              		mov     ax, [PitchTable+bx]
  2495 0000073A 894510                  		mov     [di+TrackInfo.Pitch], ax
  2496 0000073D C3                      		retn
  2497                                  TonePort:
  2498 0000073E 30F6                    		xor     dh, dh
  2499 00000740 8B4514                  		mov     ax, [di+TrackInfo.PortTo]
  2500 00000743 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2501 00000746 39C3                    		cmp     bx, ax
  2502 00000748 741E                    		je      short NoPort
  2503 0000074A 7F0A                    		jg      short PortToUp
  2504                                  PortToDown:     
  2505 0000074C 01D3                    		add     bx, dx
  2506 0000074E 39C3                    		cmp     bx, ax
  2507 00000750 7E0A                    		jle     short SetPort
  2508                                  FixPort:        
  2509 00000752 89C3                    		mov     bx, ax
  2510 00000754 EB06                    		jmp     short SetPort
  2511                                  PortToUp:
  2512 00000756 29D3                    		sub     bx, dx
  2513 00000758 39C3                    		cmp     bx, ax
  2514 0000075A 7CF6                    		jl      short FixPort
  2515                                  SetPort:        
  2516 0000075C 895D0E                  		mov     [di+TrackInfo.Period], bx
  2517 0000075F 01DB                    		add     bx, bx
  2518 00000761 8B87[E066]              		mov     ax, [PitchTable+bx]
  2519 00000765 894510                  		mov     [di+TrackInfo.Pitch], ax
  2520                                  NoPort:         
  2521 00000768 C3                      		retn
  2522                                  Vibrato:
  2523 00000769 88D6                    		mov     dh, dl
  2524 0000076B 80E20F                  		and     dl, 0Fh
  2525 0000076E C0EE04                  		shr     dh, 4
  2526 00000771 C0E602                  		shl     dh, 2
  2527 00000774 007517                  		add     [di+TrackInfo.VibPos], dh
  2528 00000777 8A7517                  		mov     dh, [di+TrackInfo.VibPos]
  2529 0000077A 88F3                    		mov     bl, dh
  2530 0000077C C0EB02                  		shr     bl, 2
  2531 0000077F 83E31F                  		and     bx, 1Fh
  2532 00000782 8A87[0D0E]              		mov     al, [SinTable+bx]
  2533 00000786 F6E2                    		mul     dl
  2534 00000788 D1C0                    		rol     ax, 1
  2535 0000078A 86C4                    		xchg    al, ah
  2536 0000078C 80E401                  		and     ah, 1
  2537 0000078F 84F6                    		test    dh, dh
  2538 00000791 7902                    		jns     short VibUp
  2539 00000793 F7D8                    		neg     ax
  2540                                  VibUp:          
  2541 00000795 03450E                  		add     ax, [di+TrackInfo.Period]
  2542 00000798 89C3                    		mov     bx, ax
  2543 0000079A 83FB71                  		cmp     bx, 113
  2544 0000079D 7D03                    		jge     short NoLoVib
  2545 0000079F BB7100                  		mov     bx, 113
  2546                                  NoLoVib:        
  2547 000007A2 81FB5803                		cmp     bx, 856
  2548 000007A6 7E03                    		jle     short NoHiVib
  2549 000007A8 BB5803                  		mov     bx, 856
  2550                                  NoHiVib:        
  2551 000007AB 01DB                    		add     bx, bx
  2552 000007AD 8B87[E066]              		mov     ax, [PitchTable+bx]
  2553 000007B1 894510                  		mov     [di+TrackInfo.Pitch], ax
  2554 000007B4 C3                      		retn
  2555                                  PortSlide:
  2556 000007B5 E80D00                  		call    VolSlide
  2557 000007B8 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2558 000007BB EB81                    		jmp     short TonePort
  2559                                  VibSlide:
  2560 000007BD E80500                  		call    VolSlide
  2561 000007C0 8A5518                  		mov     dl, [di+TrackInfo.VibParm]
  2562 000007C3 EBA4                    		jmp     short Vibrato
  2563                                  VolSlide:
  2564 000007C5 88D6                    		mov     dh, dl
  2565 000007C7 80E20F                  		and     dl, 0Fh
  2566 000007CA C0EE04                  		shr     dh, 4
  2567 000007CD 8A450C                  		mov     al, [di+TrackInfo.Volume]
  2568 000007D0 28D0                    		sub     al, dl
  2569 000007D2 7D02                    		jge     short NoLoVol
  2570 000007D4 30C0                    		xor     al, al
  2571                                  NoLoVol:        
  2572 000007D6 00F0                    		add     al, dh
  2573 000007D8 3C40                    		cmp     al, 64
  2574 000007DA 7602                    		jbe     short NoHiVol
  2575 000007DC B040                    		mov     al, 64
  2576                                  NoHiVol:        
  2577 000007DE 88450C                  		mov     [di+TrackInfo.Volume], al
  2578 000007E1 C3                      		retn
  2579                                  
  2580                                  ;--------------------------------------------------------------------------
  2581                                  ; GetTrack:   Get the next Note from a pattern.
  2582                                  ;  In:
  2583                                  ;    ds:di -  Track info Address.
  2584                                  ;    es:si -  Pattern Note Address.
  2585                                  ; Out:
  2586                                  ;    es:si -  The Next Pattern Note address.
  2587                                  ;--------------------------------------------------------------------------
  2588                                  
  2589                                  GetTrack:
  2590 000007E2 26AD                    		es lodsw
  2591 000007E4 86C4                    		xchg    al, ah
  2592 000007E6 88E3                    		mov     bl, ah
  2593 000007E8 80E40F                  		and     ah, 0Fh
  2594 000007EB 89C1                    		mov     cx, ax
  2595 000007ED 26AD                    		es lodsw
  2596 000007EF 86C4                    		xchg    al, ah
  2597 000007F1 88E7                    		mov     bh, ah
  2598 000007F3 80E40F                  		and     ah, 0Fh
  2599 000007F6 89C2                    		mov     dx, ax
  2600 000007F8 895512                  		mov     [di+TrackInfo.Effect], dx
  2601 000007FB 80E3F0                  		and     bl, 0F0h
  2602 000007FE C0EF04                  		shr     bh, 4
  2603 00000801 08FB                    		or      bl, bh
  2604 00000803 742E                    		je      short SetPeriod
  2605                                  SetSample:
  2606 00000805 30FF                    		xor     bh, bh
  2607 00000807 4B                      		dec     bx
  2608 00000808 01DB                    		add     bx, bx
  2609 0000080A 8B87[A266]              		mov     ax, [ModInfo.SampVol+bx]
  2610 0000080E 88450C                  		mov     [di+TrackInfo.Volume], al
  2611 00000811 8B87[6C65]              		mov     ax, [ModInfo.SampOfs+bx]
  2612 00000815 8905                    		mov     [di+TrackInfo.Samples], ax
  2613 00000817 8B87[AA65]              		mov     ax, [ModInfo.SampSeg+bx]
  2614 0000081B 894502                  		mov     [di+TrackInfo.Samples+2], ax
  2615 0000081E 8B87[E865]              		mov     ax, [ModInfo.SampLen+bx]
  2616 00000822 894506                  		mov     [di+TrackInfo.Len], ax
  2617 00000825 8B87[2666]              		mov     ax, [ModInfo.SampRep+bx]
  2618 00000829 894508                  		mov     [di+TrackInfo.Repeat], ax
  2619 0000082C 8B87[6466]              		mov     ax, [ModInfo.SampRepLen+bx]
  2620 00000830 89450A                  		mov     [di+TrackInfo.RepLen], ax
  2621                                  SetPeriod:      
  2622 00000833 85C9                    		test    cx, cx
  2623 00000835 741B                    		je      short SetEffect
  2624                                  
  2625 00000837 894D14                  		mov     [di+TrackInfo.PortTo], cx
  2626 0000083A 80FE03                  		cmp     dh, 03h
  2627 0000083D 7413                    		je      short SetEffect
  2628                                  
  2629 0000083F 894D0E                  		mov     [di+TrackInfo.Period], cx
  2630 00000842 89CB                    		mov     bx, cx
  2631 00000844 01DB                    		add     bx, bx
  2632 00000846 8B87[E066]              		mov     ax, [PitchTable+bx]
  2633 0000084A 894510                  		mov     [di+TrackInfo.Pitch], ax
  2634 0000084D C745040000              		mov     word [di+TrackInfo.Position], 0
  2635                                  SetEffect:
  2636 00000852 85D2                    		test    dx, dx
  2637 00000854 742A                    		je      short InitNone
  2638 00000856 80FE00                  		cmp     dh, 00h
  2639 00000859 0F84C400                		je      InitArpeggio
  2640 0000085D 80FE03                  		cmp     dh, 03h
  2641 00000860 741F                    		je      short InitTonePort
  2642 00000862 80FE04                  		cmp     dh, 04h
  2643 00000865 7428                    		je      short InitVibrato
  2644 00000867 80FE09                  		cmp     dh, 09h
  2645 0000086A 744A                    		je      short SampleOfs
  2646 0000086C 80FE0B                  		cmp     dh, 0Bh
  2647 0000086F 7457                    		je      short PosJump
  2648 00000871 80FE0C                  		cmp     dh, 0Ch
  2649 00000874 745C                    		je      short SetVolume
  2650 00000876 80FE0D                  		cmp     dh, 0Dh
  2651 00000879 7462                    		je      short Break
  2652 0000087B 80FE0F                  		cmp     dh, 0Fh
  2653 0000087E 7478                    		je      short SetSpeed
  2654                                  InitNone:
  2655 00000880 C3                      		retn
  2656                                  InitTonePort:
  2657 00000881 84D2                    		test    dl, dl
  2658 00000883 7503                    		jne     short SetPortParm
  2659 00000885 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2660                                  SetPortParm:    
  2661 00000888 885516                  		mov     [di+TrackInfo.PortParm], dl
  2662 0000088B 895512                  		mov     [di+TrackInfo.Effect], dx
  2663 0000088E C3                      		retn
  2664                                  InitVibrato:
  2665 0000088F 8A4518                  		mov     al, [di+TrackInfo.VibParm]
  2666 00000892 88C4                    		mov     ah, al
  2667 00000894 240F                    		and     al, 0Fh
  2668 00000896 80E4F0                  		and     ah, 0F0h
  2669 00000899 F6C20F                  		test    dl, 0Fh
  2670 0000089C 7502                    		jne     short OkDepth
  2671 0000089E 08C2                    		or      dl, al
  2672                                  OkDepth:        
  2673 000008A0 F6C2F0                  		test    dl, 0F0h
  2674 000008A3 7502                    		jne     short OkRate
  2675 000008A5 08E2                    		or      dl, ah
  2676                                  OkRate:         
  2677 000008A7 885518                  		mov     [di+TrackInfo.VibParm], dl
  2678 000008AA 895512                  		mov     [di+TrackInfo.Effect], dx
  2679 000008AD 85C9                    		test    cx, cx
  2680 000008AF 7404                    		je      short OkPos
  2681 000008B1 C6451700                		mov     byte [di+TrackInfo.VibPos], 0
  2682                                  OkPos:          
  2683 000008B5 C3                      		retn
  2684                                  SampleOfs:      
  2685 000008B6 84D2                    		test    dl, dl
  2686 000008B8 7503                    		jne     short SetSampleOfs
  2687 000008BA 8A5519                  		mov     dl, [di+TrackInfo.OldSampOfs]
  2688                                  SetSampleOfs:
  2689 000008BD 885519                  		mov     [di+TrackInfo.OldSampOfs], dl
  2690 000008C0 88D6                    		mov     dh, dl
  2691 000008C2 30D2                    		xor     dl, dl
  2692 000008C4 895504                  		mov     [di+TrackInfo.Position], dx
  2693 000008C7 C3                      		retn
  2694                                  PosJump:
  2695 000008C8 8816[92BE]              		mov     [OrderPos], dl
  2696 000008CC C606[96BE]40            		mov     byte [Row], 64
  2697 000008D1 C3                      		retn
  2698                                  SetVolume:
  2699 000008D2 80FA40                  		cmp     dl, 64
  2700 000008D5 7602                    		jbe     short OkVol
  2701 000008D7 B240                    		mov     dl, 64
  2702                                  OkVol:
  2703 000008D9 88550C                  		mov     [di+TrackInfo.Volume], dl
  2704 000008DC C3                      		retn
  2705                                  Break:
  2706 000008DD 88D6                    		mov     dh, dl
  2707 000008DF 80E20F                  		and     dl, 0Fh
  2708 000008E2 C0EE04                  		shr     dh, 4
  2709 000008E5 00F6                    		add     dh, dh
  2710 000008E7 00F2                    		add     dl, dh
  2711 000008E9 C0E602                  		shl     dh, 2
  2712 000008EC 00F2                    		add     dl, dh
  2713 000008EE 8816[97BE]              		mov     [BreakRow], dl
  2714 000008F2 C606[96BE]40            		mov     byte [Row], 64
  2715 000008F7 C3                      		retn
  2716                                  SetSpeed:
  2717 000008F8 84D2                    		test    dl,dl
  2718 000008FA 7424                    		je      Skip
  2719 000008FC 80FA1F                  		cmp     dl,31
  2720 000008FF 7709                    		ja      short SetBpm
  2721                                  SetTempo:       
  2722 00000901 8816[93BE]              		mov     [Tempo], dl
  2723 00000905 8816[94BE]              		mov     [TempoWait], dl
  2724 00000909 C3                      		retn
  2725                                  SetBpm:
  2726 0000090A 8816[95BE]              		mov     [Bpm], dl
  2727 0000090E B067                    		mov     al, 103
  2728 00000910 F6E2                    		mul     dl
  2729 00000912 88E3                    		mov     bl, ah
  2730 00000914 30FF                    		xor     bh, bh
  2731 00000916 A1[E464]                		mov     ax, [MixSpeed]
  2732 00000919 31D2                    		xor     dx, dx
  2733 0000091B F7F3                    		div     bx
  2734 0000091D A3[98BE]                		mov     [BpmSamples], ax
  2735                                  Skip:           
  2736 00000920 C3                      		retn
  2737                                  InitArpeggio:
  2738 00000921 88D6                    		mov     dh, dl
  2739 00000923 80E20F                  		and     dl, 0Fh
  2740 00000926 C0EE04                  		shr     dh, 4
  2741 00000929 B92400                  		mov     cx, 36
  2742 0000092C 31DB                    		xor     bx, bx
  2743 0000092E 8B450E                  		mov     ax, [di+TrackInfo.Period]
  2744                                  gt_ScanPeriod:
  2745 00000931 3B87[2D0E]              		cmp     ax, [PeriodTable+bx]
  2746 00000935 7305                    		jae     short SetArp
  2747 00000937 83C302                  		add     bx, 2
  2748 0000093A E2F5                    		loop    gt_ScanPeriod
  2749                                  SetArp:         
  2750 0000093C 01D2                    		add     dx, dx
  2751 0000093E 00DE                    		add     dh, bl
  2752 00000940 00DA                    		add     dl, bl
  2753 00000942 8B9F[2D0E]              		mov     bx, [PeriodTable+bx]
  2754 00000946 01DB                    		add     bx, bx
  2755 00000948 8B87[E066]              		mov     ax, [PitchTable+bx]
  2756 0000094C 89451A                  		mov     [di+TrackInfo.Arp], ax
  2757 0000094F 88F3                    		mov     bl, dh
  2758 00000951 30FF                    		xor     bh, bh
  2759 00000953 8B9F[2D0E]              		mov     bx, [PeriodTable+bx]
  2760 00000957 01DB                    		add     bx, bx
  2761 00000959 8B87[E066]              		mov     ax, [PitchTable+bx]
  2762 0000095D 89451C                  		mov     [di+TrackInfo.Arp+2], ax
  2763 00000960 88D3                    		mov     bl, dl
  2764 00000962 30FF                    		xor     bh, bh
  2765 00000964 8B9F[2D0E]              		mov     bx, [PeriodTable+bx]
  2766 00000968 01DB                    		add     bx, bx
  2767 0000096A 8B87[E066]              		mov     ax, [PitchTable+bx]
  2768 0000096E 89451E                  		mov     [di+TrackInfo.Arp+4], ax
  2769 00000971 C745200000              		mov     word [di+TrackInfo.ArpIndex], 0
  2770 00000976 C3                      		retn
  2771                                  
  2772                                  ;--------------------------------------------------------------------------
  2773                                  ; UpdateTracks:  Main code to process the next tick to be played.
  2774                                  ;--------------------------------------------------------------------------
  2775                                  
  2776                                  UpdateTracks:
  2777 00000977 FE0E[94BE]              		dec     byte [TempoWait]
  2778 0000097B 740F                    		jz      short GetTracks
  2779                                  
  2780 0000097D B90400                  		mov	cx, NumTracks
  2781 00000980 BF[A4BE]                		mov	di, Tracks
  2782                                  BeatTracks:
  2783 00000983 E830FD                  		call	BeatTrack	
  2784 00000986 83C722                  		add	di, TrackInfo.size
  2785 00000989 E2F8                    		loop	BeatTracks
  2786 0000098B C3                      		retn
  2787                                  GetTracks:
  2788 0000098C A0[93BE]                		mov     al, [Tempo]
  2789 0000098F A2[94BE]                		mov     [TempoWait], al
  2790                                  
  2791 00000992 C436[A0BE]              		les     si, [Note]
  2792 00000996 803E[96BE]40            		cmp     byte [Row], 64
  2793 0000099B 7246                    		jb      short NoPattWrap
  2794                                  
  2795 0000099D C436[6865]              		les     si, [ModInfo.Patterns]
  2796 000009A1 8A1E[92BE]              		mov     bl, [OrderPos]
  2797 000009A5 3A1E[E664]              		cmp     bl, [ModInfo.OrderLen]
  2798 000009A9 720E                    		jb      short NoOrderWrap
  2799 000009AB 8A1E[E764]              		mov     bl, [ModInfo.ReStart]
  2800 000009AF 881E[92BE]              		mov     [OrderPos], bl
  2801 000009B3 3A1E[E664]              		cmp     bl, [ModInfo.OrderLen]
  2802 000009B7 7343                    		jae     short NoUpdate
  2803                                  NoOrderWrap:    
  2804 000009B9 30FF                    		xor     bh, bh
  2805 000009BB 8A9F[E864]              		mov     bl, [ModInfo.Order+bx]
  2806 000009BF C1E30A                  		shl     bx, 10
  2807 000009C2 01DE                    		add     si, bx
  2808 000009C4 8A1E[97BE]              		mov     bl, [BreakRow]
  2809 000009C8 881E[96BE]              		mov     [Row], bl
  2810 000009CC 30FF                    		xor     bh, bh
  2811 000009CE 883E[97BE]              		mov     [BreakRow], bh
  2812 000009D2 C1E304                  		shl     bx, 4
  2813 000009D5 01DE                    		add     si, bx
  2814 000009D7 8936[A0BE]              		mov     [Note], si
  2815 000009DB 8C06[A2BE]              		mov     [Note+2], es
  2816 000009DF FE06[92BE]              		inc     byte [OrderPos]
  2817                                  NoPattWrap:     
  2818 000009E3 FE06[96BE]              		inc     byte [Row]
  2819                                  
  2820 000009E7 FC                      		cld
  2821 000009E8 B90400                  		mov	cx, NumTracks
  2822 000009EB BF[A4BE]                		mov	di, Tracks
  2823                                  GetTracks_next:
  2824 000009EE 51                      		push	cx		
  2825 000009EF E8F0FD                  		call	GetTrack
  2826 000009F2 59                      		pop	cx
  2827 000009F3 83C722                  		add	di, TrackInfo.size
  2828 000009F6 E2F6                    		loop	GetTracks_next
  2829                                  
  2830 000009F8 8936[A0BE]              		mov     [Note], si
  2831                                  NoUpdate:
  2832 000009FC C3                      		retn
  2833                                  
  2834                                  ;--------------------------------------------------------------------------
  2835                                  ; MixTrack:  Mixes one track into a CLEAN buffer.
  2836                                  ;  In:
  2837                                  ;   ds:si -  Track Info Address.
  2838                                  ;   ds:di -  Buffer Address.
  2839                                  ;    cx   -  Buffer Size.
  2840                                  ;--------------------------------------------------------------------------
  2841                                  
  2842                                  MixTrack:
  2843 000009FD 837C0A02                		cmp     word [si+TrackInfo.RepLen], 2
  2844 00000A01 7742                    		ja      short MixLooped
  2845                                  MixNonLooped:   
  2846 00000A03 C414                    		les     dx, [si+TrackInfo.Samples]
  2847 00000A05 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2848 00000A08 8B6C06                  		mov     bp, [si+TrackInfo.Len]
  2849 00000A0B 52                      		push    dx
  2850 00000A0C 56                      		push    si
  2851 00000A0D 01D3                    		add     bx, dx
  2852 00000A0F 01D5                    		add     bp, dx
  2853 00000A11 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2854 00000A14 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2855 00000A17 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2856 00000A1A 89DE                    		mov     si, bx
  2857 00000A1C 88C7                    		mov     bh, al
  2858 00000A1E 88D0                    		mov     al, dl
  2859 00000A20 88F2                    		mov     dl, dh
  2860 00000A22 30F6                    		xor     dh, dh
  2861                                  nlMixSamp:      
  2862 00000A24 39EE                    		cmp     si, bp
  2863 00000A26 7310                    		jae     short nlMixBye
  2864 00000A28 268A1C                  		mov     bl, [es:si]
  2865 00000A2B 8A9F[926D]              		mov     bl, [VolTable+bx]
  2866 00000A2F 001D                    		add     [di], bl
  2867 00000A31 47                      		inc     di
  2868 00000A32 00C4                    		add     ah, al
  2869 00000A34 11D6                    		adc     si, dx
  2870 00000A36 E2EC                    		loop    nlMixSamp
  2871                                  nlMixBye:       
  2872 00000A38 89F3                    		mov     bx, si
  2873 00000A3A 5E                      		pop     si
  2874 00000A3B 5A                      		pop     dx
  2875 00000A3C 29D3                    		sub     bx, dx
  2876 00000A3E 895C04                  		mov     [si+TrackInfo.Position], bx
  2877 00000A41 88640D                  		mov     [si+TrackInfo.Error], ah
  2878 00000A44 C3                      		retn
  2879                                  MixLooped:
  2880 00000A45 C414                    		les     dx, [si+TrackInfo.Samples]
  2881 00000A47 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2882 00000A4A 8B6C0A                  		mov     bp, [si+TrackInfo.RepLen]
  2883 00000A4D 892E[9EBE]              		mov     [BufRep], bp
  2884 00000A51 036C08                  		add     bp, [si+TrackInfo.Repeat]
  2885 00000A54 52                      		push    dx
  2886 00000A55 56                      		push    si
  2887 00000A56 01D3                    		add     bx, dx
  2888 00000A58 01D5                    		add     bp, dx
  2889 00000A5A 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2890 00000A5D 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2891 00000A60 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2892 00000A63 89DE                    		mov     si, bx
  2893 00000A65 88C7                    		mov     bh, al
  2894 00000A67 88D0                    		mov     al, dl
  2895 00000A69 88F2                    		mov     dl, dh
  2896 00000A6B 30F6                    		xor     dh, dh
  2897                                  lpMixSamp:      
  2898 00000A6D 39EE                    		cmp     si, bp
  2899 00000A6F 7204                    		jb      short lpMixNow
  2900 00000A71 2B36[9EBE]              		sub     si, [BufRep]
  2901                                  lpMixNow:       
  2902 00000A75 268A1C                  		mov     bl, [es:si]
  2903 00000A78 8A9F[926D]              		mov     bl, [VolTable+bx]
  2904 00000A7C 001D                    		add     [di], bl
  2905 00000A7E 47                      		inc     di
  2906 00000A7F 00C4                    		add     ah, al
  2907 00000A81 11D6                    		adc     si, dx
  2908 00000A83 E2E8                    		loop    lpMixSamp
  2909                                  lpMixBye:       
  2910 00000A85 89F3                    		mov     bx, si
  2911 00000A87 5E                      		pop     si
  2912 00000A88 5A                      		pop     dx
  2913 00000A89 29D3                    		sub     bx, dx
  2914 00000A8B 895C04                  		mov     [si+TrackInfo.Position], bx
  2915 00000A8E 88640D                  		mov     [si+TrackInfo.Error], ah
  2916 00000A91 C3                      		retn
  2917                                  
  2918                                  GetSamples_ICH:
  2919                                  		; 11/05/2024
  2920                                  		; 18/02/2017
  2921                                  		; 8 bit mono samples 
  2922                                  		; must be converted to 16 bit, stereo samples (for ICH) !
  2923                                  		; (ICH AC97 Modification by Erdogan Tan)
  2924 00000A92 8936[B0C3]              		mov	[_si_], si ; DMA Buff Addr, [DMA_BUFFER1] or [DMA_BUFFER2]
  2925                                  		; 11/05/2024
  2926                                  		;mov	si, MOD_BUFFER
  2927                                  		;shr	cx, 2 ; mod buffer size = dma (half) buffer size / 4 (*)
  2928                                  
  2929                                  ;--------------------------------------------------------------------------
  2930                                  ; GetSamples:  Returns the next chunk of samples to be played.
  2931                                  ;  In:
  2932                                  ;    Buffer  - Buffer Address.
  2933                                  ;    Count   - Buffer Size.
  2934                                  ;--------------------------------------------------------------------------
  2935                                  
  2936                                  GetSamples:
  2937                                  		;ds:si = buffer address
  2938                                  		;cx = count
  2939                                  
  2940                                  		; 11/05/2024
  2941                                  		;
  2942                                  		;;[sp+6] = ds
  2943                                  		;;[sp+4] = si
  2944                                  		;;[sp+2] = count
  2945                                  		;
  2946                                  		;Count	equ 4
  2947                                  		;Buffer	equ 6 
  2948                                  		;
  2949                                  		;push	bp
  2950                                  		;mov	bp, sp
  2951                                  		;
  2952                                  		;push    es
  2953                                  		;;;push  ds
  2954                                  		;;;pusha
  2955                                  		;
  2956                                  		;cld
  2957                                  		;
  2958                                  		;les	di, [bp+Buffer]
  2959                                  		;mov    bx, [bp+Count]
  2960                                  
  2961                                  		; 11/05/2024
  2962                                  		; ds = cs
  2963 00000A96 06                      		push	es ; +
  2964                                  
  2965 00000A97 1E                      		push	ds
  2966 00000A98 07                      		pop	es
  2967                                  
  2968                                  		; 11/05/2024
  2969 00000A99 BF[B2C3]                		mov	di, MOD_BUFFER
  2970 00000A9C BB000A                  		mov	bx, (BUFFERSIZE/4) ; (*) ; 2048
  2971                                  NextChunk:
  2972 00000A9F 833E[9CBE]00            		cmp     word [BufLen], 0
  2973 00000AA4 7534                    		jne     short CopyChunk
  2974                                  
  2975                                  		; 11/05/2024
  2976 00000AA6 06                      		push	es
  2977 00000AA7 53                      		push	bx
  2978 00000AA8 57                      		push	di
  2979                                  MixChunk:       
  2980                                  		;lea    di, [MixBuffer]
  2981 00000AA9 BF[92AE]                		mov	di, MixBuffer
  2982 00000AAC 8B0E[98BE]              		mov     cx, [BpmSamples]
  2983 00000AB0 893E[9ABE]              		mov     [BufPtr], di
  2984 00000AB4 890E[9CBE]              		mov     [BufLen], cx
  2985                                  
  2986                                  		; 12/05/2024
  2987                                  		; es = ds
  2988                                  		;mov    ax, ds
  2989                                  		;mov    es, ax
  2990                                  
  2991 00000AB8 B080                    		mov    al, 80h
  2992 00000ABA F3AA                    		rep    stosb
  2993                                  
  2994 00000ABC B90400                  		mov	cx, NumTracks
  2995 00000ABF BE[82BE]                		mov	si, Tracks - TrackInfo.size
  2996                                  GetSamples_next:
  2997 00000AC2 51                      		push	cx
  2998 00000AC3 83C622                  		add	si, TrackInfo.size
  2999 00000AC6 8B0E[9CBE]              		mov	cx, [BufLen]
  3000 00000ACA 8B3E[9ABE]              		mov	di, [BufPtr]
  3001 00000ACE E82CFF                  		call	MixTrack
  3002 00000AD1 59                      		pop	cx
  3003 00000AD2 E2EE                    		loop	GetSamples_next
  3004                                  
  3005 00000AD4 E8A0FE                  		call    UpdateTracks
  3006                                  
  3007 00000AD7 5F                      		pop	di
  3008 00000AD8 5B                      		pop	bx
  3009 00000AD9 07                      		pop	es ; es = ds ; 12/05/2024
  3010                                  CopyChunk:      
  3011 00000ADA 8B0E[9CBE]              		mov     cx, [BufLen]
  3012 00000ADE 39D9                    		cmp     cx, bx
  3013 00000AE0 7602                    		jbe     short MoveChunk
  3014 00000AE2 89D9                    		mov     cx, bx
  3015                                  MoveChunk:
  3016 00000AE4 8B36[9ABE]              		mov     si, [BufPtr]
  3017 00000AE8 010E[9ABE]              		add     [BufPtr], cx
  3018 00000AEC 290E[9CBE]              		sub     [BufLen], cx
  3019 00000AF0 29CB                    		sub     bx, cx
  3020 00000AF2 F3A4                    		rep     movsb
  3021 00000AF4 85DB                    		test    bx, bx
  3022 00000AF6 75A7                    		jnz     short NextChunk
  3023                                  
  3024                                  		;;popa
  3025                                  		;;pop	ds
  3026                                  		;pop	es
  3027                                  		;pop	bp
  3028                                  		;ret	6
  3029                                  
  3030                                  ; GetSamples_ICH_convert_samples:
  3031                                  		; 11/05/2024
  3032                                  		; es = ds = cs
  3033                                  		; 18/02/2017
  3034                                  		;mov	di, ds
  3035                                  		;mov	es, di
  3036 00000AF8 8B3E[B0C3]              		mov	di, [_si_] ; DMA Buffer Address (16 bit, stereo)
  3037 00000AFC BE[B1C3]                		mov	si, MOD_BUFFER - 1 ; buffer for 8 bit mono samples
  3038 00000AFF B9000A                  		mov	cx, (BUFFERSIZE/4) ; (*) ; 2048 ; 11/04/2024
  3039 00000B02 30C0                    		xor	al, al
  3040                                  gscs_loop:		
  3041 00000B04 46                      		inc	si
  3042 00000B05 8A24                    		mov	ah, [si] ; convert 8 bit sample to 16 bit sample
  3043                                  		; 11/05/2024
  3044 00000B07 80EC80                  		sub	ah, 80h
  3045                                  
  3046 00000B0A AB                      		stosw	; left channel
  3047 00000B0B AB                      		stosw	; right channel
  3048 00000B0C E2F6                    		loop	gscs_loop
  3049                                  
  3050                                  		; 11/05/2024
  3051 00000B0E 07                      		pop	es ; +
  3052                                  		;pop	bp
  3053                                  		;ret	6
  3054 00000B0F C3                      		retn
  3055                                  
  3056                                  ;--------------------------------------------------------------------------
  3057                                  ; StartPlaying: Initializes the Sound System.
  3058                                  ;  In:
  3059                                  ;   Module Information Resources.
  3060                                  ;--------------------------------------------------------------------------
  3061                                  
  3062                                  StartPlaying:
  3063 00000B10 60                      		pusha
  3064 00000B11 1E                      		push    ds
  3065 00000B12 06                      		push    es
  3066                                  SetModParms:    
  3067 00000B13 C606[92BE]00            		mov     byte [OrderPos], 0
  3068 00000B18 C606[93BE]06            		mov     byte [Tempo], DefTempo
  3069 00000B1D C606[94BE]06            		mov     byte [TempoWait], DefTempo
  3070 00000B22 C606[95BE]7D            		mov     byte [Bpm], DefBpm
  3071 00000B27 C606[96BE]40            		mov     byte [Row], 64
  3072 00000B2C C606[97BE]00            		mov     byte [BreakRow], 0
  3073 00000B31 A1[E464]                		mov     ax, [MixSpeed]
  3074 00000B34 31D2                    		xor     dx, dx
  3075 00000B36 BB3200                  		mov     bx, 24*DefBpm/60
  3076 00000B39 F7F3                    		div     bx
  3077 00000B3B A3[98BE]                		mov     [BpmSamples], ax
  3078                                  ClearTracks:    
  3079 00000B3E BF[A4BE]                		mov     di, Tracks
  3080 00000B41 8CD8                    		mov     ax, ds
  3081 00000B43 8EC0                    		mov     es, ax
  3082 00000B45 B98800                  		mov     cx, NumTracks*TrackInfo.size
  3083 00000B48 31C0                    		xor     ax, ax
  3084 00000B4A FC                      		cld
  3085 00000B4B F3AA                    		rep     stosb
  3086                                  
  3087 00000B4D A3[9ABE]                		mov     [BufPtr], ax
  3088 00000B50 A3[9CBE]                		mov     [BufLen], ax
  3089                                  MakePitch:
  3090 00000B53 B80021                  		mov     ax, MidCRate
  3091 00000B56 BBAC01                  		mov     bx, 428
  3092 00000B59 F7E3                    		mul     bx
  3093 00000B5B F736[E464]              		div     word [MixSpeed]
  3094 00000B5F 30F6                    		xor     dh, dh
  3095 00000B61 88E2                    		mov     dl, ah
  3096 00000B63 88C4                    		mov     ah, al
  3097 00000B65 30C0                    		xor     al, al
  3098 00000B67 B95903                  		mov     cx, 857
  3099 00000B6A 31DB                    		xor     bx, bx
  3100 00000B6C BF[E066]                		mov     di, PitchTable
  3101                                  PitchLoop:      
  3102 00000B6F 50                      		push    ax
  3103 00000B70 52                      		push    dx
  3104 00000B71 39DA                    		cmp     dx, bx
  3105 00000B73 7302                    		jae     short NoDiv
  3106 00000B75 F7F3                    		div     bx
  3107                                  NoDiv:          
  3108 00000B77 AB                      		stosw
  3109 00000B78 5A                      		pop     dx
  3110 00000B79 58                      		pop     ax
  3111 00000B7A 43                      		inc     bx
  3112 00000B7B E2F2                    		loop    PitchLoop
  3113                                  MakeVolume:     
  3114 00000B7D B90041                  		mov     cx, 16640
  3115 00000B80 89CB                    		mov     bx, cx
  3116                                  VolLoop:
  3117 00000B82 4B                      		dec     bx
  3118 00000B83 88D8                    		mov     al, bl
  3119 00000B85 F6EF                    		imul    bh
  3120 00000B87 88A7[926D]              		mov     [VolTable+bx], ah
  3121 00000B8B E2F5                    		loop    VolLoop
  3122                                  
  3123 00000B8D 07                      		pop     es
  3124 00000B8E 1F                      		pop     ds
  3125 00000B8F 61                      		popa
  3126 00000B90 C3                      		retn	; 12/05/2024
  3127                                  
  3128                                  ;--------------------------------------------------------------------------
  3129                                  ; StopPlaying: ShutDown the Sound System.
  3130                                  ;--------------------------------------------------------------------------
  3131                                  
  3132                                  StopPlaying:
  3133                                  	; 08/05/2024
  3134                                  	; 04/11/2023
  3135                                  	; finished with song, stop everything
  3136 00000B91 E8A801                  	call	ac97_stop
  3137                                  
  3138                                  ; 12/05/2024 (tuneloop version)
  3139                                  %if 0
  3140                                  	; 11/11/2023
  3141                                  irq_restore:	
  3142                                  	; restore previous interrupt vector and interrupt_status
  3143                                  	cli
  3144                                  	in	al, 0A1h ; irq 8-15
  3145                                  	mov	al, [IRQ_status+1]
  3146                                  	out	0A1h, al 
  3147                                  	in	al, 021h ; irq 0-7
  3148                                  	mov	al, [IRQ_status]
  3149                                  	out	21h, al 
  3150                                  	; ...
  3151                                  	push	es
  3152                                  	xor	ax, ax
  3153                                  	mov	es, ax
  3154                                  	mov	ax, [IRQ_vector]
  3155                                  	mov	[es:bx], ax
  3156                                  	mov	ax, [IRQ_vector+2]
  3157                                  	mov	[es:bx+2], ax
  3158                                  	pop	es
  3159                                  
  3160                                  	sti
  3161                                  %endif
  3162 00000B94 C3                      	retn
  3163                                  
  3164                                  ;=============================================================================
  3165                                  ;               PLAYER.ASM
  3166                                  ;=============================================================================
  3167                                  
  3168                                  ; UTILS.ASM
  3169                                  ;----------------------------------------------------------------------------
  3170                                  ;       delay1_4ms - Delay for 1/4 millisecond.
  3171                                  ;		    1mS = 1000us
  3172                                  ;       Entry:
  3173                                  ;         None
  3174                                  ;       Exit:
  3175                                  ;	  None
  3176                                  ;
  3177                                  ;       Modified:
  3178                                  ;         None
  3179                                  ;
  3180                                  PORTB			EQU	061h
  3181                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
  3182                                  
  3183                                  delay1_4ms:
  3184 00000B95 50                              push    ax 
  3185 00000B96 51                              push    cx
  3186 00000B97 B91000                          mov     cx, 16			; close enough.
  3187 00000B9A E461                    	in	al,PORTB
  3188 00000B9C 2410                    	and	al,REFRESH_STATUS
  3189 00000B9E 88C4                    	mov	ah,al			; Start toggle state
  3190 00000BA0 09C9                    	or	cx, cx
  3191 00000BA2 7401                    	jz	short _d4ms1
  3192 00000BA4 41                      	inc	cx			; Throwaway first toggle
  3193                                  _d4ms1:	
  3194 00000BA5 E461                    	in	al,PORTB		; Read system control port
  3195 00000BA7 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  3196 00000BA9 38C4                    	cmp	ah,al
  3197 00000BAB 74F8                    	je	short _d4ms1		; Wait for state change
  3198                                  
  3199 00000BAD 88C4                    	mov	ah,al			; Update with new state
  3200 00000BAF 49                      	dec	cx
  3201 00000BB0 75F3                    	jnz	short _d4ms1
  3202                                  
  3203 00000BB2 59                              pop     cx
  3204 00000BB3 58                              pop     ax
  3205 00000BB4 C3                              retn
  3206                                  
  3207                                  print_msg:
  3208                                  	; 13/11/2016 - Erdogan Tan 
  3209                                  	; esi = ASCIIZ text address
  3210                                  	;
  3211 00000BB5 BB0700                  	mov	bx, 7h
  3212 00000BB8 B40E                    	mov	ah, 0Eh 
  3213                                  pm_next_char:
  3214 00000BBA AC                      	lodsb
  3215 00000BBB 20C0                    	and	al, al
  3216 00000BBD 7404                    	jz	short pm_retn
  3217 00000BBF CD10                    	int	10h
  3218 00000BC1 EBF7                    	jmp	short pm_next_char
  3219                                  pm_retn:
  3220 00000BC3 C3                      	retn
  3221                                  
  3222                                  dword2str:
  3223                                  	; 13/11/2016 - Erdogan Tan 
  3224                                  	; eax = dword value
  3225                                  	;
  3226 00000BC4 E84400                  	call	dwordtohex
  3227 00000BC7 668916[770F]            	mov	[dword_str], edx
  3228 00000BCC 66A3[7B0F]              	mov	[dword_str+4], eax
  3229 00000BD0 BE[770F]                	mov	si, dword_str
  3230 00000BD3 C3                      	retn
  3231                                  
  3232                                  	; trdos386.s (unix386.s) - 10/05/2015
  3233                                  	; Convert binary number to hexadecimal string
  3234                                  
  3235                                  bytetohex:
  3236                                  	; INPUT ->
  3237                                  	; 	AL = byte (binary number)
  3238                                  	; OUTPUT ->
  3239                                  	;	AX = hexadecimal string
  3240                                  	;
  3241 00000BD4 53                      	push	bx
  3242 00000BD5 30FF                    	xor	bh, bh
  3243 00000BD7 88C3                    	mov	bl, al
  3244 00000BD9 C0EB04                  	shr	bl, 4
  3245 00000BDC 8A9F[D90E]              	mov	bl, [bx+hex_chars] 	 	
  3246 00000BE0 86D8                    	xchg	bl, al
  3247 00000BE2 80E30F                  	and	bl, 0Fh
  3248 00000BE5 8AA7[D90E]              	mov	ah, [bx+hex_chars] 
  3249 00000BE9 5B                      	pop	bx	
  3250 00000BEA C3                      	retn
  3251                                  
  3252                                  wordtohex:
  3253                                  	; INPUT ->
  3254                                  	; 	AX = word (binary number)
  3255                                  	; OUTPUT ->
  3256                                  	;	EAX = hexadecimal string
  3257                                  	;
  3258 00000BEB 53                      	push	bx
  3259 00000BEC 30FF                    	xor	bh, bh
  3260 00000BEE 86E0                    	xchg	ah, al
  3261 00000BF0 50                      	push	ax
  3262 00000BF1 88E3                    	mov	bl, ah
  3263 00000BF3 C0EB04                  	shr	bl, 4
  3264 00000BF6 8A87[D90E]              	mov	al, [bx+hex_chars] 	 	
  3265 00000BFA 88E3                    	mov	bl, ah
  3266 00000BFC 80E30F                  	and	bl, 0Fh
  3267 00000BFF 8AA7[D90E]              	mov	ah, [bx+hex_chars]
  3268 00000C03 66C1E010                	shl	eax, 16
  3269 00000C07 58                      	pop	ax
  3270 00000C08 5B                      	pop	bx
  3271 00000C09 EBC9                    	jmp	short bytetohex
  3272                                  
  3273                                  dwordtohex:
  3274                                  	; INPUT ->
  3275                                  	; 	EAX = dword (binary number)
  3276                                  	; OUTPUT ->
  3277                                  	;	EDX:EAX = hexadecimal string
  3278                                  	;
  3279 00000C0B 6650                    	push	eax
  3280 00000C0D 66C1E810                	shr	eax, 16
  3281 00000C11 E8D7FF                  	call	wordtohex
  3282 00000C14 6689C2                  	mov	edx, eax
  3283 00000C17 6658                    	pop	eax
  3284 00000C19 E8CFFF                  	call	wordtohex
  3285 00000C1C C3                      	retn
  3286                                  
  3287                                  	; 13/11/2016 - Erdogan Tan
  3288                                  write_ac97_dev_info:
  3289                                  	; BUS/DEV/FN
  3290                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  3291                                  	; DEV/VENDOR
  3292                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  3293                                  
  3294 00000C1D 30FF                    	xor	bh, bh
  3295 00000C1F 668B36[9E0F]            	mov	esi, [dev_vendor]
  3296 00000C24 89F0                    	mov	ax, si
  3297 00000C26 88C3                    	mov	bl, al
  3298 00000C28 88DA                    	mov	dl, bl
  3299 00000C2A 80E30F                  	and	bl, 0Fh
  3300 00000C2D 8A87[D90E]              	mov	al, [bx+hex_chars]
  3301 00000C31 A2[1C0F]                	mov	[msgVendorId+3], al
  3302 00000C34 88D3                    	mov	bl, dl
  3303 00000C36 C0EB04                  	shr	bl, 4
  3304 00000C39 8A87[D90E]              	mov	al, [bx+hex_chars]
  3305 00000C3D A2[1B0F]                	mov	[msgVendorId+2], al
  3306 00000C40 88E3                    	mov	bl, ah
  3307 00000C42 88DA                    	mov	dl, bl
  3308 00000C44 80E30F                  	and	bl, 0Fh
  3309 00000C47 8A87[D90E]              	mov	al, [bx+hex_chars]
  3310 00000C4B A2[1A0F]                	mov	[msgVendorId+1], al
  3311 00000C4E 88D3                    	mov	bl, dl
  3312 00000C50 C0EB04                  	shr	bl, 4
  3313 00000C53 8A87[D90E]              	mov	al, [bx+hex_chars]
  3314 00000C57 A2[190F]                	mov	[msgVendorId], al
  3315 00000C5A 66C1EE10                	shr	esi, 16
  3316 00000C5E 89F0                    	mov	ax, si
  3317 00000C60 88C3                    	mov	bl, al
  3318 00000C62 88DA                    	mov	dl, bl
  3319 00000C64 80E30F                  	and	bl, 0Fh
  3320 00000C67 8A87[D90E]              	mov	al, [bx+hex_chars]
  3321 00000C6B A2[2D0F]                	mov	[msgDevId+3], al
  3322 00000C6E 88D3                    	mov	bl, dl
  3323 00000C70 C0EB04                  	shr	bl, 4
  3324 00000C73 8A87[D90E]              	mov	al, [bx+hex_chars]
  3325 00000C77 A2[2C0F]                	mov	[msgDevId+2], al
  3326 00000C7A 88E3                    	mov	bl, ah
  3327 00000C7C 88DA                    	mov	dl, bl
  3328 00000C7E 80E30F                  	and	bl, 0Fh
  3329 00000C81 8A87[D90E]              	mov	al, [bx+hex_chars]
  3330 00000C85 A2[2B0F]                	mov	[msgDevId+1], al
  3331 00000C88 88D3                    	mov	bl, dl
  3332 00000C8A C0EB04                  	shr	bl, 4
  3333 00000C8D 8A87[D90E]              	mov	al, [bx+hex_chars]
  3334 00000C91 A2[2A0F]                	mov	[msgDevId], al
  3335                                  
  3336 00000C94 668B36[9A0F]            	mov	esi, [bus_dev_fn]
  3337 00000C99 66C1EE08                	shr	esi, 8
  3338 00000C9D 89F0                    	mov	ax, si
  3339 00000C9F 88C3                    	mov	bl, al
  3340 00000CA1 88DA                    	mov	dl, bl
  3341 00000CA3 80E307                  	and	bl, 7 ; bit 0,1,2
  3342 00000CA6 8A87[D90E]              	mov	al, [bx+hex_chars]
  3343 00000CAA A2[510F]                	mov	[msgFncNo+1], al
  3344 00000CAD 88D3                    	mov	bl, dl
  3345 00000CAF C0EB03                  	shr	bl, 3
  3346 00000CB2 88DA                    	mov	dl, bl
  3347 00000CB4 80E30F                  	and	bl, 0Fh
  3348 00000CB7 8A87[D90E]              	mov	al, [bx+hex_chars]
  3349 00000CBB A2[430F]                	mov	[msgDevNo+1], al
  3350 00000CBE 88D3                    	mov	bl, dl
  3351 00000CC0 C0EB04                  	shr	bl, 4
  3352 00000CC3 8A87[D90E]              	mov	al, [bx+hex_chars]
  3353 00000CC7 A2[420F]                	mov	[msgDevNo], al
  3354 00000CCA 88E3                    	mov	bl, ah
  3355 00000CCC 88DA                    	mov	dl, bl
  3356 00000CCE 80E30F                  	and	bl, 0Fh
  3357 00000CD1 8A87[D90E]              	mov	al, [bx+hex_chars]
  3358 00000CD5 A2[370F]                	mov	[msgBusNo+1], al
  3359 00000CD8 88D3                    	mov	bl, dl
  3360 00000CDA C0EB04                  	shr	bl, 4
  3361 00000CDD 8A87[D90E]              	mov	al, [bx+hex_chars]
  3362 00000CE1 A2[360F]                	mov	[msgBusNo], al
  3363                                  
  3364                                  	;mov	ax, [ac97_io_base]
  3365                                  	; 08/05/2024
  3366 00000CE4 A1[860F]                	mov	ax, [NABMBAR]
  3367 00000CE7 88C3                    	mov	bl, al
  3368 00000CE9 88DA                    	mov	dl, bl
  3369 00000CEB 80E30F                  	and	bl, 0Fh
  3370 00000CEE 8A87[D90E]              	mov	al, [bx+hex_chars]
  3371 00000CF2 A2[6A0F]                	mov	[msgIOBaseAddr+3], al
  3372 00000CF5 88D3                    	mov	bl, dl
  3373 00000CF7 C0EB04                  	shr	bl, 4
  3374 00000CFA 8A87[D90E]              	mov	al, [bx+hex_chars]
  3375 00000CFE A2[690F]                	mov	[msgIOBaseAddr+2], al
  3376 00000D01 88E3                    	mov	bl, ah
  3377 00000D03 88DA                    	mov	dl, bl
  3378 00000D05 80E30F                  	and	bl, 0Fh
  3379 00000D08 8A87[D90E]              	mov	al, [bx+hex_chars]
  3380 00000D0C A2[680F]                	mov	[msgIOBaseAddr+1], al
  3381 00000D0F 88D3                    	mov	bl, dl
  3382 00000D11 C0EB04                  	shr	bl, 4
  3383 00000D14 8A87[D90E]              	mov	al, [bx+hex_chars]
  3384 00000D18 A2[670F]                	mov	[msgIOBaseAddr], al
  3385                                  
  3386                                  	; 24/11/2016
  3387 00000D1B 30E4                    	xor	ah, ah
  3388 00000D1D A0[980F]                	mov	al, [ac97_int_ln_reg]
  3389 00000D20 B10A                    	mov	cl, 10
  3390 00000D22 F6F1                    	div	cl
  3391 00000D24 0106[720F]              	add	[msgIRQ], ax
  3392 00000D28 20C0                    	and	al, al
  3393 00000D2A 7508                    	jnz	short _pmi
  3394 00000D2C A0[730F]                	mov	al, [msgIRQ+1]
  3395 00000D2F B420                    	mov	ah, ' '
  3396 00000D31 A3[720F]                	mov	[msgIRQ], ax
  3397                                  _pmi:
  3398 00000D34 BA[EA0E]                        mov	dx, msgAC97Info
  3399 00000D37 B409                            mov     ah, 9
  3400 00000D39 CD21                            int     21h
  3401 00000D3B C3                              retn
  3402                                  
  3403                                  	; 08/05/2024
  3404                                  ac97_stop:
  3405                                  	; 11/11/2023
  3406                                  	; 09/11/2023
  3407                                  	; 05/11/2023
  3408                                  	; 04/11/2023 
  3409                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  3410                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  3411                                  ;_ac97_stop:
  3412                                  
  3413                                  	; 11/11/2023
  3414 00000D3C 8B16[840F]              	mov	dx, [NAMBAR]
  3415                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  3416 00000D40 EF                      	out	dx, ax
  3417                                  
  3418                                  	; 04/11/2023
  3419                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  3420                                  	; 11/06/2017
  3421 00000D41 30C0                    	xor	al, al ; 0
  3422 00000D43 E80D00                  	call	ac97_po_cmd
  3423                                  
  3424                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  3425                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  3426 00000D46 B81C00                  	mov     ax, 1Ch
  3427 00000D49 8B16[860F]              	mov     dx, [NABMBAR]
  3428 00000D4D 83C216                  	add     dx, PO_SR_REG
  3429 00000D50 EF                      	out     dx, ax
  3430                                  
  3431                                  	; 11/06/2017
  3432 00000D51 B002                    	mov     al, RR
  3433                                  ac97_po_cmd:
  3434                                  	; 11/06/2017
  3435                                  	; 29/05/2017
  3436 00000D53 8B16[860F]              	mov     dx, [NABMBAR]
  3437 00000D57 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  3438 00000D5A EE                      	out	dx, al
  3439 00000D5B C3                      	retn
  3440                                  
  3441                                  ;=============================================================================
  3442                                  ;               preinitialized data
  3443                                  ;=============================================================================
  3444                                  
  3445                                  ;=============================================================================
  3446                                  ;               PLAY.ASM - DATA
  3447                                  ;=============================================================================
  3448                                  
  3449                                  msg_2017:
  3450 00000D5C 54696E79204D4F4420-     		db	'Tiny MOD Player by Erdogan Tan. May 2024.',10,13
  3450 00000D65 506C61796572206279-
  3450 00000D6E 204572646F67616E20-
  3450 00000D77 54616E2E204D617920-
  3450 00000D80 323032342E0A0D     
  3451 00000D87 75736167653A20706C-     		db	'usage: playmod2 filename.mod', 10, 13, '$'
  3451 00000D90 61796D6F6432206669-
  3451 00000D99 6C656E616D652E6D6F-
  3451 00000DA2 640A0D24           
  3452 00000DA6 31382F30322F323031-     		db	'18/02/2017',0
  3452 00000DAF 3700               
  3453 00000DB1 31342F30352F323032-     		db	'14/05/2024',0
  3453 00000DBA 3400               
  3454                                  
  3455 00000DBC 54696E79204D4F4420-     Credits:	db	'Tiny MOD Player v0.1b by Carlos Hasan. July 1993.'
  3455 00000DC5 506C61796572207630-
  3455 00000DCE 2E3162206279204361-
  3455 00000DD7 726C6F732048617361-
  3455 00000DE0 6E2E204A756C792031-
  3455 00000DE9 3939332E           
  3456                                  CRLF:		; 13/05/2024
  3457 00000DED 0A0D24                  		db	10,13,'$'
  3458 00000DF0 4572726F72206C6F61-     ErrorMesg:	db	'Error loading Module file.',10,13,'$'
  3458 00000DF9 64696E67204D6F6475-
  3458 00000E02 6C652066696C652E0A-
  3458 00000E0B 0D24               
  3459                                  
  3460                                  ;=============================================================================
  3461                                  ;               MODPLAY.ASM - DATA
  3462                                  ;=============================================================================
  3463                                  
  3464                                  ;Credits:	db	'Amiga Module Player v0.3b by Carlos Hasan.'
  3465                                  
  3466 00000E0D 0019324A62788EA2B4-     SinTable:	db	0,25,50,74,98,120,142,162,180,197,212,225
  3466 00000E16 C5D4E1             
  3467 00000E19 ECF4FAFEFFFEFAF4EC-     		db	236,244,250,254,255,254,250,244,236,225
  3467 00000E22 E1                 
  3468 00000E23 D4C5B4A28E78624A32-     		db	212,197,180,162,142,120,98,74,50,25
  3468 00000E2C 19                 
  3469                                  
  3470 00000E2D 58032803FA02D002A6-     PeriodTable:	dw	856,808,762,720,678,640,604,570,538,508,480,453
  3470 00000E36 0280025C023A021A02-
  3470 00000E3F FC01E001C501       
  3471 00000E45 AC0194017D01680153-     		dw	428,404,381,360,339,320,302,285,269,254,240,226
  3471 00000E4E 0140012E011D010D01-
  3471 00000E57 FE00F000E200       
  3472 00000E5D D600CA00BE00B400AA-     		dw	214,202,190,180,170,160,151,143,135,127,120,113
  3472 00000E66 00A00097008F008700-
  3472 00000E6F 7F0078007100       
  3473                                  
  3474                                  ;=============================================================================
  3475                                  ;               PLAYWAV.ASM / PLAYER.ASM - DATA
  3476                                  ;=============================================================================
  3477                                  
  3478                                  ; 24/11/2016
  3479                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  3480 00000E75 08090A0B0C0D0E0F70-     irq_int:	db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  3480 00000E7E 71727374757677     
  3481                                  
  3482                                  ; 17/02/2017
  3483                                  ; Valid ICH device IDs
  3484                                  
  3485                                  valid_ids:
  3486 00000E85 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h
  3487 00000E89 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h
  3488 00000E8D 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h
  3489 00000E91 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h
  3490 00000E95 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  3491 00000E99 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  3492 00000E9D 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  3493 00000EA1 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  3494 00000EA5 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  3495 00000EA9 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  3496                                  ; 03/11/2023 - Erdogan Tan
  3497 00000EAD 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  3498 00000EB1 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  3499 00000EB5 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  3500 00000EB9 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  3501 00000EBD 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  3502 00000EC1 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  3503 00000EC5 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  3504 00000EC9 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  3505 00000ECD DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  3506 00000ED1 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  3507 00000ED5 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  3508                                  
  3509                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  3510                                  
  3511                                  ; 13/11/2016
  3512 00000ED9 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  3512 00000EE2 3941424344454600   
  3513 00000EEA 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  3513 00000EF3 6F20436F6E74726F6C-
  3513 00000EFC 6C6572202620436F64-
  3513 00000F05 656320496E666F0D0A 
  3514 00000F0E 56656E646F72204944-     		db "Vendor ID: "
  3514 00000F17 3A20               
  3515 00000F19 303030306820446576-     msgVendorId	db "0000h Device ID: "
  3515 00000F22 6963652049443A20   
  3516 00000F2A 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  3517 00000F31 4275733A20              		db "Bus: "
  3518 00000F36 303068204465766963-     msgBusNo	db "00h Device: "
  3518 00000F3F 653A20             
  3519 00000F42 3030682046756E6374-     msgDevNo	db "00h Function: "
  3519 00000F4B 696F6E3A20         
  3520 00000F50 303068                  msgFncNo	db "00h"
  3521 00000F53 0D0A                    		db 0Dh, 0Ah
  3522 00000F55 492F4F204261736520-     		db "I/O Base Address: "
  3522 00000F5E 416464726573733A20 
  3523 00000F67 303030306820495251-     msgIOBaseAddr	db "0000h IRQ: "
  3523 00000F70 3A20               
  3524 00000F72 3030                    msgIRQ		dw 3030h
  3525 00000F74 0D0A24                  		db 0Dh, 0Ah, "$"
  3526                                  
  3527                                  ;msgSampleRate	db "Sample Rate: "
  3528                                  ;msgHertz	db "00000 Hz ", "$" 
  3529                                  ;msg8Bits	db "8 bits ", "$" 
  3530                                  ;msgMono	db "Mono", 0Dh, 0Ah, "$"
  3531                                  ;msg16Bits	db "16 bits ", "$" 
  3532                                  ;msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  3533                                  
  3534                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  3535                                  ;codec_id	dd 0
  3536                                  ;codec_chip_id	dd 0
  3537                                  ;codec_vendor_ids dw 0
  3538                                  ;codec_chip_ids	dw 0
  3539                                  
  3540 00000F77 3030303030303030        dword_str	 dd 30303030h, 30303030h
  3541 00000F7F 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  3542                                  
  3543                                  ;=============================================================================
  3544                                  ;        	uninitialized data
  3545                                  ;=============================================================================
  3546                                  
  3547                                  bss_start:
  3548                                  
  3549                                  ABSOLUTE bss_start
  3550                                  
  3551 00000F83 ??                      alignb 4
  3552                                  
  3553                                  ; 17/02/2017
  3554                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  3555                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  3556                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  3557                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  3558 00000F84 ????                    NAMBAR:		resw 1			; BAR for mixer
  3559 00000F86 ????                    NABMBAR         resw 1			; BAR for bus master regs
  3560                                  
  3561 00000F88 ??                      tBuff:		resb	1
  3562                                  ;irq_status:	resb 	1
  3563 00000F89 ??                      pcm_irq_status:	resb	1 ; 08/05/2024
  3564                                  
  3565 00000F8A ??                      inside:		resb	1 
  3566 00000F8B ??                      tLoop:		resb 	1
  3567                                  
  3568                                  ; 08/05/2024
  3569 00000F8C ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  3570 00000F8E ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  3571                                  
  3572                                  ; 256 byte buffer for descriptor list
  3573 00000F92 ????                    BDL_BUFFER:	resw	1		; segment of our 256byte BDL buffer
  3574 00000F94 ????                    DMA_BUFFER1:	resw 	1		; Pointer to 1st half of DMA Buffer
  3575 00000F96 ????                    DMA_BUFFER2:	resw	1		; Pointer to 1st half of DMA Buffer
  3576                                  
  3577                                  ; 12/11/2016 - Erdogan Tan
  3578                                  
  3579 00000F98 ??                      ac97_int_ln_reg: resb 1 
  3580 00000F99 ??                      err_num:	resb 1
  3581                                  
  3582 00000F9A ????????                bus_dev_fn:	resd 1
  3583 00000F9E ????????                dev_vendor:	resd 1
  3584                                  ; 08/05/2024
  3585                                  ;stats_cmd:	resd 1
  3586                                  ;ac97_io_base:	resw 1
  3587 00000FA2 ??                      LVI:		resb 1
  3588                                  ; 12/05/2024
  3589 00000FA3 ??                      volume:		resb 1
  3590                                  
  3591                                  alignb 4
  3592                                  
  3593 00000FA4 <res 100h>              BdlBuffer:	resb	BDL_SIZE ; 13/02/2017
  3594 000010A4 <res 5000h>             DmaBuffer:	resb	2*BUFFERSIZE ; 13/02/2017
  3595                                  
  3596                                  ; MODLOAD.ASM
  3597 000060A4 ????                    FileHandle:	resw	1
  3598 000060A6 ????                    ErrorInfo:	resw	1
  3599 000060A8 <res 43Ch>              Header:		resb	ModHeader.size
  3600                                  
  3601                                  sample_rate: ; PLAYER.ASM (22050Hz)
  3602                                  ; MODPLAY.ASM
  3603 000064E4 ????                    MixSpeed:	resw 1
  3604                                  
  3605                                  ModInfo:
  3606 000064E6 ??                      ModInfo.OrderLen:   resb 1
  3607 000064E7 ??                      ModInfo.ReStart:    resb 1
  3608 000064E8 <res 80h>               ModInfo.Order:	    resb 128
  3609 00006568 ????????                ModInfo.Patterns:   resd 1
  3610                                  
  3611 0000656C <res 3Eh>               ModInfo.SampOfs:    resw 31
  3612 000065AA <res 3Eh>               ModInfo.SampSeg:    resw 31
  3613 000065E8 <res 3Eh>               ModInfo.SampLen:    resw 31
  3614 00006626 <res 3Eh>               ModInfo.SampRep:    resw 31
  3615 00006664 <res 3Eh>               ModInfo.SampRepLen: resw 31
  3616 000066A2 <res 3Eh>               ModInfo.SampVol:    resw 31
  3617                                  
  3618                                  ; MODPLAY.ASM
  3619 000066E0 <res 6B2h>              PitchTable:	resw	857
  3620 00006D92 <res 4100h>             VolTable:	resb	16640
  3621 0000AE92 <res 1000h>             MixBuffer       resb	MixBufSize
  3622                                  
  3623                                  ; MODPLAY.ASM
  3624 0000BE92 ??                      OrderPos:	resb 1
  3625 0000BE93 ??                      Tempo:		resb 1
  3626 0000BE94 ??                      TempoWait:	resb 1
  3627 0000BE95 ??                      Bpm:		resb 1
  3628 0000BE96 ??                      Row:		resb 1
  3629 0000BE97 ??                      BreakRow:	resb 1
  3630 0000BE98 ????                    BpmSamples:	resw 1
  3631 0000BE9A ????                    BufPtr:		resw 1
  3632 0000BE9C ????                    BufLen:		resw 1
  3633 0000BE9E ????                    BufRep:		resw 1
  3634 0000BEA0 ????????                Note:		resd 1
  3635 0000BEA4 <res 88h>               Tracks:		resb TrackInfo.size*NumTracks
  3636                                  
  3637 0000BF2C ????????                alignb 16
  3638                                  
  3639                                  ; PLAY.ASM
  3640 0000BF30 <res 280h>              Scope:		resw	320
  3641 0000C1B0 <res 200h>              RowOfs:		resw	256
  3642                                  
  3643                                  ; 18/02/2017
  3644 0000C3B0 ????                    _si_:		resw 1
  3645 0000C3B2 <res A00h>              MOD_BUFFER:	resb BUFFERSIZE/4 ; 2048 ; 11/05/2024
  3646                                  EOF:
